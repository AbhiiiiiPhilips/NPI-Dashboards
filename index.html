<!doctype html>
<html lang="en">
<head>
  <!-- Performance optimizations for Smartsheet -->
  <link rel="preconnect" href="https://app.smartsheet.eu" crossorigin>
  <link rel="dns-prefetch" href="https://app.smartsheet.eu">
  <link rel="preconnect" href="https://webappassets.smartsheet.eu" crossorigin>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>NPI Dashboards</title>
  <style>
    :root{
      --philips:#0e5fd8;
      --bar:#0b2b4f;
      --btn:#003366;
      --btnH:#0059b3;
      --btnDis:#7a94b8;
      --warning:#ffcc00;
    }

    html,body{margin:0;height:100%;overflow:hidden;background:#fff;font-family:"Segoe UI","Helvetica Neue",Arial,sans-serif;}

    /* Veil */
    .veil{position:fixed;inset:0;background:#fff;opacity:1;transition:opacity .6s ease;pointer-events:none;z-index:9998;}
    .veil.hidden{opacity:0}

    /* Splash */
    .splash{position:fixed;inset:0;background:var(--philips);z-index:9999;color:#fff}
    .splash-fit{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:center}
    .splash-inner{display:flex;flex-direction:column;align-items:center;gap:14px}
    .splash-logo{font-weight:900;letter-spacing:.04em;font-size:clamp(66px,14vw,180px);line-height:1.02;white-space:nowrap;
      opacity:0;transform:translateY(14px);
      animation:logoIn .5s ease-out .2s forwards,logoOut .5s ease-in 2.0s forwards;}
    .splash-tag{display:flex;align-items:center;font-size:clamp(28px,3vw,46px);font-weight:700;gap:.35ch;
      opacity:0;transform:translateX(64px);
      animation:tagSlide .8s ease-out .9s forwards,tagFade .5s ease-in 2.0s forwards;}
    /* Center loading line */
    .loading{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#fff;font-weight:800;font-size:clamp(20px,3.6vw,36px);opacity:0;text-align:center;pointer-events:none;white-space:nowrap}
    .loading .dots{display:inline-flex;gap:.28ch;margin-left:.5ch;font-size:0.9em}
    .loading .dots span{opacity:.25;display:inline-block;animation:dotPulse 1s infinite ease-in-out}
    .loading .dots span:nth-child(1){animation-delay:0s}
    .loading .dots span:nth-child(2){animation-delay:.15s}
    .loading .dots span:nth-child(3){animation-delay:.3s}
    @keyframes dotPulse{0%,100%{opacity:.25}50%{opacity:1}}
    .loading{animation:loadingIn .42s cubic-bezier(.22,.9,.35,1) 2.5s forwards}
    @keyframes loadingIn{from{opacity:0;transform:translate(-50%,-55%)}to{opacity:1;transform:translate(-50%,-50%)}}
    @media (max-width:420px){.loading{font-size:clamp(18px,5.5vw,28px)}}

    .sparkles{position:relative;width:1.25em;height:1.25em;display:inline-block;margin:0 .08em}
    .sparkles svg{position:absolute;inset:0;width:100%;height:100%;fill:#fff}
    .sparkles .back{opacity:.45;transform:translate(.18em,-.14em) scale(.78)}
    .sparkles .front{opacity:1}
    .splash.fade-out{animation:fadeSplash .8s ease-in forwards}

    @keyframes logoIn{to{opacity:1;transform:translateY(0)}}
    @keyframes logoOut{to{opacity:0;transform:translateY(-20px)}}
    @keyframes tagSlide{to{opacity:1;transform:translateX(0)}}
    @keyframes tagFade{to{opacity:0;transform:translateX(-20px)}}
    @keyframes fadeSplash{to{opacity:0;visibility:hidden}}

    .sparkles{position:relative;width:1.25em;height:1.25em;display:inline-block;margin:0 .08em}
    .sparkles svg{position:absolute;inset:0;width:100%;height:100%;fill:#fff}
    .sparkles .back{opacity:.45;transform:translate(.18em,-.14em) scale(.78)}
    .sparkles .front{opacity:1}
    .splash.fade-out{animation:fadeSplash .8s ease-in forwards}

    @keyframes logoIn{to{opacity:1;transform:translateY(0)}}
    @keyframes logoOut{to{opacity:0;transform:translateY(-20px)}}
    @keyframes tagSlide{to{opacity:1;transform:translateX(0)}}
    @keyframes tagFade{to{opacity:0;transform:translateX(-20px)}}
    @keyframes fadeSplash{to{opacity:0;visibility:hidden}}

    /* Refresh Status Box */
    .refresh-status {
      position: fixed;
      top: 70px;
      right: 20px;
      width: 200px;
      background: var(--bar);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      color: white;
      z-index: 9999;
      padding: 12px;
      display: none;
      font-size: 13px;
      cursor: move;
      user-select: none;
      opacity: 0;
      transition: opacity 0.3s ease-out;
    }

    .refresh-status.active {
      display: block;
      opacity: 1;
    }

    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .status-message {
      margin-bottom: 8px;
      font-weight: 500;
    }

    .time-remaining {
      color: rgba(255,255,255,0.9);
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 12px;
    }

    /* Toast notification */
    .toast-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bar);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
    }

    .toast-notification.show {
      display: block;
    }

    .progress-container {
      width: 100%;
      height: 4px;
      background: #eee;
      border-radius: 2px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-bar {
      width: 0%;
      height: 100%;
      background: var(--philips);
      transition: width 0.5s ease;
    }

    .status-footer {
      text-align: center;
      color: #666;
      font-size: 13px;
    }

    /* Disable refresh buttons during update */
    .refresh-button.disabled {
      opacity: 0.5;
      pointer-events: none;
      cursor: not-allowed;
    }

    /* Top bar and Navigation */
    .top{
      position:fixed;
      inset:0 0 auto 0;
      height:56px;
      display:flex;
      gap:10px;
      align-items:center;
      padding:0 14px;
      background:var(--bar);
      color:#fff;
      z-index:100;
      opacity:0;
      transition:opacity 1s ease
    }

    /* Dropdown Menu */
    .nav-item {
      position: relative;
      display: inline-block;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--bar);
      border-radius: 8px;
      padding: 8px;
      min-width: 220px;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
      z-index: 1000;
      margin-top: 2px;
    }

    /* Add padding to create hoverable area between button and dropdown */
    .nav-item::after {
      content: '';
      position: absolute;
      height: 10px;
      left: 0;
      right: 0;
      bottom: -10px;
    }

    /* Show dropdown on hover and keep it visible while hovering the gap */
    .nav-item:hover .dropdown {
      display: block;
      animation: fadeIn 0.1s ease-out;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      transition: background .15s ease-in-out;
      font-weight: 500;
      white-space: nowrap;
    }

    .dropdown-item:hover {
      background: var(--btnH);
    }

    .dropdown-item svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
      flex-shrink: 0;
    }

    .dropdown-item.refresh-button {
      color: var(--warning);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .btn{display:inline-block;border:0;border-radius:12px;padding:8px 14px;font-weight:700;color:#fff;background:#104071;text-decoration:none}
    .btn{transition:transform .12s ease, box-shadow .12s ease, background-color .12s ease}
    .btn:active{transform:translateY(1px) scale(.995); box-shadow:inset 0 2px 6px rgba(0,0,0,.25); background:var(--btnH)}
    .top a.btn:hover{background:var(--btnH)}
    .top a.btn.selected{background:#fff;color:var(--bar);box-shadow:0 6px 20px rgba(0,0,0,.18)}

    /* Stage */
    .stage{position:absolute;inset:56px 0 0 0;opacity:0;transition:opacity .6s ease}
    iframe{width:100%;height:100%;border:0;background:#fff}
    .slide {
      overflow-y: auto;
      overflow-x: hidden;
    }
    .slide img {
      width: 100%;
      height: auto;
      display: block;
      background: #fff;
    }

    /* Project containers */
    .project{position:absolute;inset:0;transition:opacity .3s ease}
    .project.inactive{opacity:0;z-index:0;pointer-events:none}
    .project.active{opacity:1;z-index:1;pointer-events:auto}

    /* Slider */
    .slides{position:absolute;inset:0}
    .slide{
      position:absolute;
      inset:0;
      opacity:0;
      pointer-events:none;
      transition:opacity 0.3s ease;
      height: 100%;
      overflow-y: auto;
    }
    .slide.active{
      opacity:1;
      pointer-events:auto;
      z-index:1;
    }
    .controls{position:absolute;left:0;right:0;bottom:18px;display:flex;justify-content:space-between;align-items:center;padding:0 22px;z-index:30}
    .controls .btn{padding:10px 16px;font-size:14px;background:var(--btn)}
    .controls .btn:hover{background:var(--btnH)}
    .controls .btn[disabled]{background:var(--btnDis);cursor:not-allowed;opacity:.65}
    .counter{color:#fff;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:8px;font-weight:700}
  </style>
</head>
<body>
  <!-- Refresh Status Box -->
  <div id="refresh-status" class="refresh-status">
    <div class="status-header">
      <span>⋮⋮</span>
      <span class="time-remaining"><span>10</span> min remaining</span>
    </div>
    <div class="status-message">Initializing update...</div>
    <div class="progress-container">
      <div class="progress-bar"></div>
    </div>
  </div>

  <!-- SPLASH -->
  <div id="splash" class="splash">
    <div class="splash-fit">
      <div class="splash-inner">
        <div class="splash-logo">PHILIPS</div>
        <div class="splash-tag">
          <span>innovation</span>
          <span class="sparkles">
            <svg class="back" viewBox="0 0 24 24"><path d="M12 2l1.8 5.4L19 9.5l-5.2 1.7L12 16l-1.8-4.8L5 9.5l5.2-2.1L12 2z"/></svg>
            <svg class="front" viewBox="0 0 24 24"><path d="M12 2l1.8 5.4L19 9.5l-5.2 1.7L12 16l-1.8-4.8L5 9.5l5.2-2.1L12 2z"/></svg>
          </span>
          <span>you</span>
        </div>
        <div id="splash-loading" class="loading" aria-hidden="true">
          <span>Loading NPI Dashboards</span>
          <span class="dots"><span>.</span><span>.</span><span>.</span></span>
        </div>
      </div>
    </div>
  </div>
  <div class="veil" id="veil"></div>

  <!-- NAVIGATION -->
  <div class="top" id="topbar">
    <a class="btn" href="#home" data-route="home">Home</a>
    
    <div class="nav-item">
      <a class="btn" href="#vm13" data-route="vm13">VM 13.0</a>
      <div class="dropdown">
  <a class="dropdown-item refresh-button" href="#" onclick="refreshDashboards('VM 13.0')">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Refresh Dashboards
        </a>
        <a class="dropdown-item edit-button" href="https://app.smartsheet.eu/workspaces/W7JvM9F6XMVhxv7ffw4rVJfg4CM7xgfxjPC5JHf1" target="_blank">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Edit Data
        </a>
      </div>
    </div>

    <div class="nav-item">
      <a class="btn" href="#blaze" data-route="blaze">Blaze 1.0</a>
      <div class="dropdown">
  <a class="dropdown-item refresh-button" href="#" onclick="refreshDashboards('Blaze 1.0')">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Refresh Dashboards
        </a>
        <a class="dropdown-item edit-button" href="https://app.smartsheet.eu/workspaces/MP68x2GxfFg79xcqvJhFw5hjhGQQ9j7G5G3QXQh1" target="_blank">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Edit Data
        </a>
      </div>
    </div>

    <div class="nav-item">
      <a class="btn" href="#vm14" data-route="vm14">VM 14.0</a>
      <div class="dropdown">
  <a class="dropdown-item refresh-button" href="#" onclick="refreshDashboards('VM 14.0')">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Refresh Dashboards
        </a>
        <a class="dropdown-item edit-button" href="https://app.smartsheet.eu/workspaces/gM9wv3Rqwphqjj6hj4gHrGfPmrJWMFhhfCf7X6G1" target="_blank">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Edit Data
        </a>
      </div>
    </div>
    
    <div class="spacer"></div>
  </div>

  <!-- DASHBOARDS -->
  <div class="stage" id="stage">
    <!-- HOME - Live URL -->
    <div id="view-home" class="project active">
      <iframe 
        src="https://app.smartsheet.eu/b/publish?EQBCT=d75deb97e5c544d98de6b1b5c4c6f2b6" 
        loading="eager" 
        fetchpriority="high"
        importance="high"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope"
        referrerpolicy="no-referrer"></iframe>
    </div>

    <!-- VM13 -->
    <div id="view-vm13" class="project inactive">
      <div class="slides">
        <div class="slide active"><img src="snapshots/2025-09/VM 13.0/Dashboard-1.png" alt="VM13 Dashboard 1" loading="eager"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-2.png" alt="VM13 Dashboard 2"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-3.png" alt="VM13 Dashboard 3"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-4.png" alt="VM13 Dashboard 4"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-5.png" alt="VM13 Dashboard 5"></div>
      </div>
      <div class="controls"><button class="btn prev">⟨ Prev</button><div class="counter">1 / 5</div><button class="btn next">Next ⟩</button></div>
    </div>

    <!-- Blaze -->
    <div id="view-blaze" class="project inactive">
      <div class="slides">
        <div class="slide active"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-1.png" alt="Blaze Dashboard 1" loading="eager"></div>
        <div class="slide"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-2.png" alt="Blaze Dashboard 2"></div>
        <div class="slide"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-3.png" alt="Blaze Dashboard 3"></div>
        <div class="slide"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-4.png" alt="Blaze Dashboard 4"></div>
      </div>
      <div class="controls"><button class="btn prev">⟨ Prev</button><div class="counter">1 / 4</div><button class="btn next">Next ⟩</button></div>
    </div>

    <!-- VM14 -->
    <div id="view-vm14" class="project inactive">
      <div class="slides">
        <div class="slide active"><img src="snapshots/2025-09/VM 14.0/Dashboard-1.png" alt="VM14 Dashboard 1" loading="eager"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-2.png" alt="VM14 Dashboard 2"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-3.png" alt="VM14 Dashboard 3"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-4.png" alt="VM14 Dashboard 4"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-5.png" alt="VM14 Dashboard 5"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-6.png" alt="VM14 Dashboard 6"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-7.png" alt="VM14 Dashboard 7"></div>
      </div>
      <div class="controls"><button class="btn prev">⟨ Prev</button><div class="counter">1 / 7</div><button class="btn next">Next ⟩</button></div>
    </div>
  </div>

 <script>
  // Constants  
  const WORKFLOW_PAT_NEW = '${{ secrets.WORKFLOW_PAT_NEW }}';  // Will be replaced during build
  const SPLASH_TIMEOUT = 3000;  // Maximum splash screen wait time
  
  const ROUTES = ['home', 'vm13', 'blaze', 'vm14'];
  const CONTAINERS = ROUTES.reduce((acc, route) => {
    acc[route] = document.getElementById(`view-${route}`);
    return acc;
  }, {});

  let currentSliders = {};

  function show(route){
    ROUTES.forEach(r=>{
      const el=CONTAINERS[r];if(!el)return;
      if(r===route){
        el.classList.add('active');
        el.classList.remove('inactive');
        // Initialize slider for this route if it hasn't been yet
        if(r !== 'home' && !currentSliders[r]) {
          setupSlider(el);
        }
      } else {
        el.classList.remove('active');
        el.classList.add('inactive');
      }
    });
    if(location.hash.replace('#','')!==route)location.hash=route;
  }



  function setupSlider(project) {
    if (project.id === 'view-home') return;
    
    const slides = Array.from(project.querySelectorAll('.slide'));
    const [prev, next] = project.querySelectorAll('.btn');
    const counter = project.querySelector('.counter');
    if (!slides.length) return;

    let currentIndex = 0;

    function updateSlides() {
      slides.forEach((s, i) => s.classList.toggle('active', i === currentIndex));
      counter.textContent = `${currentIndex + 1} / ${slides.length}`;
      prev.disabled = currentIndex === 0;
      next.disabled = currentIndex === slides.length - 1;
    }

    prev.onclick = () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateSlides();
      }
    };

    next.onclick = () => {
      if (currentIndex < slides.length - 1) {
        currentIndex++;
        updateSlides();
      }
    };

    updateSlides();
    currentSliders[project.id.replace('view-', '')] = { currentIndex, slides };
  }

  function setupSliders() {
    document.querySelectorAll('.project').forEach(setupSlider);
  }

  // Initialize on page load
  window.addEventListener('load', () => {
    const splash = document.getElementById('splash');
    const veil = document.getElementById('veil');
    const topbar = document.getElementById('topbar');
    const stage = document.getElementById('stage');
    const homeIframe = document.querySelector('#view-home iframe');

    function showUI() {
      veil?.classList.add('hidden');
      topbar.style.opacity = '1';
      stage.style.opacity = '1';
    }

    function removeSplash() {
      splash?.classList.add('fade-out');
      setTimeout(() => {
        splash?.remove();
        veil?.remove();
        showUI();
      }, 400);
    }

    // Handle home iframe load
    if (homeIframe) {
      homeIframe.addEventListener('load', removeSplash, { once: true });
    }

    // Fallback
    setTimeout(removeSplash, SPLASH_TIMEOUT);

    // Set initial route
    const initialRoute = location.hash.slice(1) || 'home';
    updateNavSelection(initialRoute);
    setupSliders();
  });

  function updateNavSelection(route){
    document.querySelectorAll('.top a.btn[data-route]').forEach(a=>{
      const is = a.dataset.route===route;
      a.classList.toggle('selected', is);
      if(is) a.setAttribute('aria-current','page'); else a.removeAttribute('aria-current');
    });
  }

  document.querySelectorAll('.top a.btn[data-route]').forEach(a=>{
    a.addEventListener('click',e=>{
      e.preventDefault();
      show(a.dataset.route);
      updateNavSelection(a.dataset.route);
    });
  });

  window.addEventListener('hashchange',()=>{
    const r=(location.hash||'#home').replace('#','');
    const route = ROUTES.includes(r)?r:'home';
    show(route);
    updateNavSelection(route);
  });

  function showDashboard(project) {
    show(project);
    updateNavSelection(project);
  }

  async function refreshDashboards(project) {
    const statusBox = document.getElementById('refresh-status');
    const messageEl = statusBox.querySelector('.status-message');
    const progressBar = statusBox.querySelector('.progress-bar');
    const timeRemaining = statusBox.querySelector('.time-remaining span');
    const statusFooter = statusBox.querySelector('.status-footer');
    const steps = statusBox.querySelectorAll('.step');
    
    // Disable all refresh buttons
    document.querySelectorAll('.refresh-button').forEach(btn => {
      btn.classList.add('disabled');
    });

    statusBox.classList.add('active');

    // Initialize update state
    const updateState = {
      startTime: Date.now(),
      totalTime: 10 * 60 * 1000, // 10 minutes in milliseconds
      currentStep: 0,
      isCompleted: false,
      timer: null
    };

    // Check for existing workflow
    const workflowKey = 'current_workflow_update';
    const existingWorkflow = localStorage.getItem(workflowKey);
    
    if (existingWorkflow) {
      const workflowData = JSON.parse(existingWorkflow);
      const isRecent = Date.now() - workflowData.timestamp < 600000; // 10 minutes
      
      if (isRecent) {
        updateState.startTime = workflowData.timestamp;
        updateState.currentStep = workflowData.step || 0;
        messageEl.textContent = 'Resuming update...';
        statusFooter.textContent = `Continuing update for ${workflowData.project}`;
      } else {
        localStorage.removeItem(workflowKey);
      }
    }

    // Update messages for different stages of the process
    const updateMessages = [
      "Initializing workflow...",
      "Connecting to GitHub...",
      "Capturing latest data...",
      "Processing dashboard information...",
      "Updating visuals...",
      "Saving changes...",
      "Almost done..."
    ];

    const updateProgress = (percent, message, timeLeft) => {
      // Update progress bar
      progressBar.style.width = `${percent}%`;
      
      // Update message
      if (message) messageEl.textContent = message;
      
      // Update time
      if (typeof timeLeft === 'number') {
        const minutes = Math.floor(timeLeft / 60000);
        if (timeLeft <= 60000) { // Last minute
          const seconds = Math.floor((timeLeft % 60000) / 1000);
          timeRemaining.textContent = `${seconds} sec remaining`;
        } else {
          timeRemaining.textContent = `${minutes} min remaining`;
        }
      }
    };

    // Store the start time in localStorage to handle tab switches
    localStorage.setItem('refresh_start_time', updateState.startTime.toString());

    // Start time update interval
    updateState.timer = setInterval(() => {
      const storedStartTime = parseInt(localStorage.getItem('refresh_start_time'));
      const elapsed = Date.now() - storedStartTime;
      const timeLeft = updateState.totalTime - elapsed;
      const progress = Math.min(95, (elapsed / updateState.totalTime) * 100);
      
      if (timeLeft <= 0 && !updateState.isCompleted) {
        clearInterval(updateState.timer);
        window.location.reload();
        return;
      }

      // Update message based on progress
      const messageIndex = Math.floor((updateMessages.length - 1) * (progress / 100));
      updateProgress(progress, updateMessages[messageIndex], timeLeft);
    }, 1000);

    try {
      // Check if token exists
      if (!WORKFLOW_PAT_NEW || WORKFLOW_PAT_NEW === '${{ secrets.WORKFLOW_PAT_NEW }}') {
        throw new Error('GitHub token not properly configured');
      }

      // Clean and validate project name
      const fullProjectName = (typeof project === 'string') ? project.replace(/^\s+|\s+$/g, '').replace(/^['"]|['"]$/g, '') : project;
      if (fullProjectName !== 'VM 13.0' && fullProjectName !== 'Blaze 1.0' && fullProjectName !== 'VM 14.0') {
        throw new Error(`Invalid project name: ${fullProjectName}`);
      }

      // Initialize workflow
      updateProgress(10, 'Initializing workflow...', updateState.totalTime);
      
      const response = await fetch('https://api.github.com/repos/Abhinav-PIC/NPI-Dashboards/dispatches', {
        method: 'POST',
        headers: {
          'Accept': 'application/vnd.github.v3+json',
          'Authorization': `token ${WORKFLOW_PAT_NEW}`,
          'Content-Type': 'application/json',
          'X-GitHub-Api-Version': '2022-11-28'
        },
        body: JSON.stringify({
          event_type: 'manual_refresh',
          client_payload: { 
            project: fullProjectName,
            timestamp: Date.now(),
            action: 'refresh_dashboards'
          }
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('GitHub API Error:', {
          status: response.status,
          statusText: response.statusText,
          error: errorText
        });
        throw new Error(`GitHub API Error: ${response.status} - ${errorText || response.statusText}`)
      }

      updateProgress(20, 'Installing dependencies...', 'Setting up environment');

      let lastWorkflowStatus = '';
      // Store workflow ID in localStorage to track refresh
      const workflowKey = 'current_workflow_update';
      
      // Poll for completion
      for (let i = 0; i < 36; i++) {
        await new Promise(r => setTimeout(r, 5000));
        
        try {
          const response = await fetch(
            'https://api.github.com/repos/Abhinav-PIC/NPI-Dashboards/actions/runs?event=repository_dispatch&per_page=1',
            {
              headers: {
                'Accept': 'application/vnd.github.v3+json',
                'Authorization': `Bearer ${WORKFLOW_PAT_NEW}`
              }
            }
          );
          
          if (!response.ok) {
            throw new Error('Failed to fetch workflow status');
          }

          const { workflow_runs } = await response.json();

          if (!workflow_runs?.[0]) {
            updateProgress(30, 'Capturing latest data...', 'Processing dashboard information');
            continue;
          }

          const run = workflow_runs[0];
          const status = run.status;
          
          // Store workflow run ID and status
          localStorage.setItem(workflowKey, JSON.stringify({
            id: run.id,
            status: status,
            conclusion: run.conclusion,
            project: fullProjectName,
            timestamp: Date.now()
          }));

          // Check for cancellation or failure
          if (status === 'completed') {
            if (run.conclusion === 'cancelled') {
              throw new Error('Update cancelled');
            } else if (run.conclusion === 'failure') {
              throw new Error('Update failed');
            }
          }

          // Get total dashboard count based on project
          const dashboardCount = fullProjectName === 'VM 14.0' ? 7 : 
                               fullProjectName === 'VM 13.0' ? 5 : 
                               fullProjectName === 'Blaze 1.0' ? 4 : 0;
          
          // Calculate progress based on workflow steps
          const progress = (() => {
            switch(status) {
              case 'queued': return 10;
              case 'in_progress': {
                // Get steps from workflow
                const stepsCompleted = Math.min(i + 1, dashboardCount); // Use polling iteration as a progress indicator
                return Math.min(20 + (stepsCompleted / dashboardCount * 60), 80);
              }
              case 'completed': return run.conclusion === 'success' ? 100 : 0;
              default: return 30;
            }
          })();
          
          // Update the UI with current progress
          updateProgress(
            progress,
            status === 'in_progress' ? 'Updating dashboards...' : 
            status === 'queued' ? 'Waiting for workflow to start...' : 
            status === 'completed' && run.conclusion === 'success' ? 'Update complete!' : 'Processing...',
            status === 'in_progress' ? `Processing dashboard ${Math.min(i + 1, dashboardCount)}/${dashboardCount}` :
            status === 'queued' ? 'In queue' :
            status === 'completed' && run.conclusion === 'success' ? 'Refreshing page...' : ''
          );

          if (status === 'completed' && run.conclusion === 'success') {
            updateState.isCompleted = true;
            localStorage.removeItem(workflowKey);
            updateProgress(100, 4, 'Update completed successfully!');
            statusFooter.textContent = 'Refreshing page...';
            clearInterval(updateState.timer);
            
            // Re-enable refresh buttons before reload
            document.querySelectorAll('.refresh-button').forEach(btn => {
              btn.classList.remove('disabled');
            });
            
            setTimeout(() => window.location.reload(), 2000);
            return;
          }

        } catch (error) {
          console.error('Error checking workflow status:', error);
          handleUpdateError('Failed to check workflow status');
        }
      }
      // If we get here, we've timed out
      handleUpdateError('Update timed out');

    } catch (error) {
      console.error('Error:', error);
      handleUpdateError(error.message);
    }
  }

  function handleUpdateError(errorMessage) {
    const statusBox = document.getElementById('refresh-status');
    const messageEl = statusBox.querySelector('.status-message');
    const statusFooter = statusBox.querySelector('.status-footer');
    const progressBar = statusBox.querySelector('.progress-bar');
    const timeRemaining = statusBox.querySelector('.time-remaining');

    // Clear any existing intervals
    clearInterval(updateState?.timer);

    // Clear the workflow storage
    localStorage.removeItem('current_workflow_update');
    
    // Update UI to show error
    messageEl.textContent = '⚠️ Update Failed';
    statusFooter.textContent = errorMessage;
    progressBar.style.width = '100%';
    progressBar.style.background = '#ff6b6b';
    timeRemaining.style.display = 'none';

    // Re-enable refresh buttons
    document.querySelectorAll('.refresh-button').forEach(btn => {
      btn.classList.remove('disabled');
    });

    // Make status box dismissible
    statusBox.onclick = () => {
      statusBox.classList.remove('active');
      progressBar.style.background = 'var(--philips)';
      timeRemaining.style.display = 'block';
    };

    // Auto-hide after 10 seconds
    setTimeout(() => {
      statusBox.classList.remove('active');
      progressBar.style.background = 'var(--philips)';
      timeRemaining.style.display = 'block';
    }, 10000);
  }

  // Add page visibility and storage change handling
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      const workflowData = localStorage.getItem('current_workflow_update');
      if (workflowData) {
        try {
          const { project, timestamp } = JSON.parse(workflowData);
          // Only resume if the update is less than 10 minutes old
          if (Date.now() - timestamp < 600000) {
            refreshDashboards(project);
          } else {
            localStorage.removeItem('current_workflow_update');
          }
        } catch (e) {
          localStorage.removeItem('current_workflow_update');
        }
      }
    }
  });

  function showToast(message, duration = 5000) {
    let toast = document.querySelector('.toast-notification');
    if (!toast) {
      toast = document.createElement('div');
      toast.className = 'toast-notification';
      document.body.appendChild(toast);
    }
    
    toast.textContent = message;
    toast.classList.add('show');
    
    setTimeout(() => {
      toast.classList.remove('show');
    }, duration);
  }

  // Make status box draggable
  function makeDraggable(element) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    const header = element.querySelector('.status-header');
    
    if (header) {
      header.onmousedown = dragMouseDown;
    } else {
      element.onmousedown = dragMouseDown;
    }

    function dragMouseDown(e) {
      e = e || window.event;
      e.preventDefault();
      // get the mouse cursor position at startup
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      // call a function whenever the cursor moves
      document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
      e = e || window.event;
      e.preventDefault();
      // calculate the new cursor position
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      // set the element's new position
      const newTop = (element.offsetTop - pos2);
      const newLeft = (element.offsetLeft - pos1);
      
      // Keep within viewport bounds
      const maxX = window.innerWidth - element.offsetWidth;
      const maxY = window.innerHeight - element.offsetHeight;
      
      element.style.top = Math.min(maxY, Math.max(0, newTop)) + "px";
      element.style.left = Math.min(maxX, Math.max(0, newLeft)) + "px";
      element.style.right = 'auto';
    }

    function closeDragElement() {
      document.onmouseup = null;
      document.onmousemove = null;
    }
  }

  // Initialize draggable status box
  const statusBox = document.getElementById('refresh-status');
  if (statusBox) makeDraggable(statusBox);

  // Listen for storage changes in other tabs
  window.addEventListener('storage', (e) => {
    if (e.key === 'current_workflow_update') {
      if (!e.newValue) {
        // Update was completed or cancelled in another tab
        window.location.reload();
      }
    }
  });

  // Show notification when returning to tab if update completed
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      const workflowData = localStorage.getItem('current_workflow_update');
      if (!workflowData && document.querySelector('.refresh-status.active')) {
        showToast('Dashboard update completed! Refreshing page...');
        setTimeout(() => window.location.reload(), 2000);
      }
    }
  });
</script>

</body>
</html>