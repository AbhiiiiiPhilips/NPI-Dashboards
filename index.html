<!doctype html>
<html lang="en">
<head>
  <!-- Performance optimizations for Smartsheet -->
  <link rel="preconnect" href="https://app.smartsheet.eu" crossorigin>
  <link rel="dns-prefetch" href="https://app.smartsheet.eu">
  <link rel="preconnect" href="https://webappassets.smartsheet.eu" crossorigin>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>NPI Dashboards</title>
  <style>
    :root{
      --philips:#0e5fd8;
      --bar:#0b2b4f;
      --btn:#003366;
      --btnH:#0059b3;
      --btnDis:#7a94b8;
      --warning:#ffcc00;
    }

    html,body{margin:0;height:100%;overflow:hidden;background:#fff;font-family:"Segoe UI","Helvetica Neue",Arial,sans-serif;}

    /* Veil */
    .veil{position:fixed;inset:0;background:#fff;opacity:1;transition:opacity .6s ease;pointer-events:none;z-index:9998;}
    .veil.hidden{opacity:0}

    /* Splash */
    .splash{position:fixed;inset:0;background:var(--philips);z-index:9999;color:#fff}
    .splash-fit{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:center}
    .splash-inner{display:flex;flex-direction:column;align-items:center;gap:14px}
    .splash-logo{font-weight:900;letter-spacing:.04em;font-size:clamp(66px,14vw,180px);line-height:1.02;white-space:nowrap;
      opacity:0;transform:translateY(14px);
      animation:logoIn .5s ease-out .2s forwards,logoOut .5s ease-in 2.0s forwards;}
    .splash-tag{display:flex;align-items:center;font-size:clamp(28px,3vw,46px);font-weight:700;gap:.35ch;
      opacity:0;transform:translateX(64px);
      animation:tagSlide .8s ease-out .9s forwards,tagFade .5s ease-in 2.0s forwards;}
    /* Center loading line */
    .loading{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#fff;font-weight:800;font-size:clamp(20px,3.6vw,36px);opacity:0;text-align:center;pointer-events:none;white-space:nowrap}
    .loading .dots{display:inline-flex;gap:.28ch;margin-left:.5ch;font-size:0.9em}
    .loading .dots span{opacity:.25;display:inline-block;animation:dotPulse 1s infinite ease-in-out}
    .loading .dots span:nth-child(1){animation-delay:0s}
    .loading .dots span:nth-child(2){animation-delay:.15s}
    .loading .dots span:nth-child(3){animation-delay:.3s}
    @keyframes dotPulse{0%,100%{opacity:.25}50%{opacity:1}}
    .loading{animation:loadingIn .42s cubic-bezier(.22,.9,.35,1) 2.5s forwards}
    @keyframes loadingIn{from{opacity:0;transform:translate(-50%,-55%)}to{opacity:1;transform:translate(-50%,-50%)}}
    @media (max-width:420px){.loading{font-size:clamp(18px,5.5vw,28px)}}

    .sparkles{position:relative;width:1.25em;height:1.25em;display:inline-block;margin:0 .08em}
    .sparkles svg{position:absolute;inset:0;width:100%;height:100%;fill:#fff}
    .sparkles .back{opacity:.45;transform:translate(.18em,-.14em) scale(.78)}
    .sparkles .front{opacity:1}
    .splash.fade-out{animation:fadeSplash .8s ease-in forwards}

    @keyframes logoIn{to{opacity:1;transform:translateY(0)}}
    @keyframes logoOut{to{opacity:0;transform:translateY(-20px)}}
    @keyframes tagSlide{to{opacity:1;transform:translateX(0)}}
    @keyframes tagFade{to{opacity:0;transform:translateX(-20px)}}
    @keyframes fadeSplash{to{opacity:0;visibility:hidden}}

    .sparkles{position:relative;width:1.25em;height:1.25em;display:inline-block;margin:0 .08em}
    .sparkles svg{position:absolute;inset:0;width:100%;height:100%;fill:#fff}
    .sparkles .back{opacity:.45;transform:translate(.18em,-.14em) scale(.78)}
    .sparkles .front{opacity:1}
    .splash.fade-out{animation:fadeSplash .8s ease-in forwards}

    @keyframes logoIn{to{opacity:1;transform:translateY(0)}}
    @keyframes logoOut{to{opacity:0;transform:translateY(-20px)}}
    @keyframes tagSlide{to{opacity:1;transform:translateX(0)}}
    @keyframes tagFade{to{opacity:0;transform:translateX(-20px)}}
    @keyframes fadeSplash{to{opacity:0;visibility:hidden}}


    /* Refresh Overlay */
    .refresh-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      z-index: 9999;
      padding: 20px;
    }

    .refresh-overlay.active {
      display: flex;
    }

    .refresh-overlay .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--philips);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .refresh-overlay .message {
      font-size: 1.2em;
      text-align: center;
      max-width: 80%;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .refresh-overlay .progress-container {
      width: 300px;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
      margin: 20px 0;
    }

    .refresh-overlay .progress-bar {
      width: 0%;
      height: 100%;
      background: var(--philips);
      transition: width 0.5s ease;
    }

    .refresh-overlay .status {
      font-size: 0.9em;
      color: rgba(255,255,255,0.8);
      margin-top: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Top bar and Navigation */
    .top{
      position:fixed;
      inset:0 0 auto 0;
      height:56px;
      display:flex;
      gap:10px;
      align-items:center;
      padding:0 14px;
      background:var(--bar);
      color:#fff;
      z-index:100;
      opacity:0;
      transition:opacity 1s ease
    }

    /* Dropdown Menu */
    .nav-item {
      position: relative;
      display: inline-block;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--bar);
      border-radius: 8px;
      padding: 8px;
      min-width: 220px;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
      z-index: 1000;
      margin-top: 2px;
    }

    /* Add padding to create hoverable area between button and dropdown */
    .nav-item::after {
      content: '';
      position: absolute;
      height: 10px;
      left: 0;
      right: 0;
      bottom: -10px;
    }

    /* Add padding to create hoverable area between button and dropdown */
    .nav-item::after {
      content: '';
      position: absolute;
      height: 10px;
      left: 0;
      right: 0;
      bottom: -10px;
    }

    /* Show dropdown on hover and keep it visible while hovering the gap */
    .nav-item:hover .dropdown {
      display: block;
      animation: fadeIn 0.1s ease-out;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      transition: background .15s ease-in-out;
      font-weight: 500;
      white-space: nowrap;
    }

    .dropdown-item:hover {
      background: var(--btnH);
    }

    .dropdown-item svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
      flex-shrink: 0;
    }

    .dropdown-item.refresh-button {
      color: var(--warning);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .btn{display:inline-block;border:0;border-radius:12px;padding:8px 14px;font-weight:700;color:#fff;background:#104071;text-decoration:none}
    .btn{transition:transform .12s ease, box-shadow .12s ease, background-color .12s ease}
    .btn:active{transform:translateY(1px) scale(.995); box-shadow:inset 0 2px 6px rgba(0,0,0,.25); background:var(--btnH)}
    .top a.btn:hover{background:var(--btnH)}
    .top a.btn.selected{background:#fff;color:var(--bar);box-shadow:0 6px 20px rgba(0,0,0,.18)}

    /* Stage */
    .stage{position:absolute;inset:56px 0 0 0;opacity:0;transition:opacity .6s ease}
    iframe{width:100%;height:100%;border:0;background:#fff}
    .slide {
      overflow-y: auto;
      overflow-x: hidden;
    }
    .slide img {
      width: 100%;
      height: auto;
      display: block;
      background: #fff;
    }

    /* Project containers */
    .project{position:absolute;inset:0;transition:opacity .3s ease}
    .project.inactive{opacity:0;z-index:0;pointer-events:none}
    .project.active{opacity:1;z-index:1;pointer-events:auto}

    /* Slider */
    .slides{position:absolute;inset:0}
    .slide{
      position:absolute;
      inset:0;
      opacity:0;
      pointer-events:none;
      transition:opacity 0.3s ease;
      height: 100%;
      overflow-y: auto;
    }
    .slide.active{
      opacity:1;
      pointer-events:auto;
      z-index:1;
    }
    .controls{position:absolute;left:0;right:0;bottom:18px;display:flex;justify-content:space-between;align-items:center;padding:0 22px;z-index:30}
    .controls .btn{padding:10px 16px;font-size:14px;background:var(--btn)}
    .controls .btn:hover{background:var(--btnH)}
    .controls .btn[disabled]{background:var(--btnDis);cursor:not-allowed;opacity:.65}
    .counter{color:#fff;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:8px;font-weight:700}
  </style>
</head>
<body>
  <!-- Refresh Overlay -->
  <div id="refresh-overlay" class="refresh-overlay">
    <div class="spinner"></div>
    <div class="message">Capturing latest dashboard data</div>
    <div class="progress-container">
      <div class="progress-bar"></div>
    </div>
    <div class="status"></div>
  </div>

  <!-- SPLASH -->
  <div id="splash" class="splash">
    <div class="splash-fit">
      <div class="splash-inner">
        <div class="splash-logo">PHILIPS</div>
        <div class="splash-tag">
          <span>innovation</span>
          <span class="sparkles">
            <svg class="back" viewBox="0 0 24 24"><path d="M12 2l1.8 5.4L19 9.5l-5.2 1.7L12 16l-1.8-4.8L5 9.5l5.2-2.1L12 2z"/></svg>
            <svg class="front" viewBox="0 0 24 24"><path d="M12 2l1.8 5.4L19 9.5l-5.2 1.7L12 16l-1.8-4.8L5 9.5l5.2-2.1L12 2z"/></svg>
          </span>
          <span>you</span>
        </div>
        <div id="splash-loading" class="loading" aria-hidden="true">
          <span>Loading NPI Dashboards</span>
          <span class="dots"><span>.</span><span>.</span><span>.</span></span>
        </div>
      </div>
    </div>
  </div>
  <div class="veil" id="veil"></div>

  <!-- NAVIGATION -->
  <div class="top" id="topbar">
    <a class="btn" href="#home" data-route="home">Home</a>
    
    <div class="nav-item">
      <a class="btn" href="#vm13" data-route="vm13">VM 13.0</a>
      <div class="dropdown">
  <a class="dropdown-item refresh-button" href="#" onclick="refreshDashboards('VM 13.0')">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Refresh Dashboards
        </a>
        <a class="dropdown-item edit-button" href="https://app.smartsheet.eu/workspaces/W7JvM9F6XMVhxv7ffw4rVJfg4CM7xgfxjPC5JHf1" target="_blank">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Edit Data
        </a>
      </div>
    </div>

    <div class="nav-item">
      <a class="btn" href="#blaze" data-route="blaze">Blaze 1.0</a>
      <div class="dropdown">
  <a class="dropdown-item refresh-button" href="#" onclick="refreshDashboards('Blaze 1.0')">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Refresh Dashboards
        </a>
        <a class="dropdown-item edit-button" href="https://app.smartsheet.eu/workspaces/MP68x2GxfFg79xcqvJhFw5hjhGQQ9j7G5G3QXQh1" target="_blank">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Edit Data
        </a>
      </div>
    </div>

    <div class="nav-item">
      <a class="btn" href="#vm14" data-route="vm14">VM 14.0</a>
      <div class="dropdown">
  <a class="dropdown-item refresh-button" href="#" onclick="refreshDashboards('VM 14.0')">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Refresh Dashboards
        </a>
        <a class="dropdown-item edit-button" href="https://app.smartsheet.eu/workspaces/gM9wv3Rqwphqjj6hj4gHrGfPmrJWMFhhfCf7X6G1" target="_blank">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Edit Data
        </a>
      </div>
    </div>
    
    <div class="spacer"></div>
  </div>

  <!-- DASHBOARDS -->
  <div class="stage" id="stage">
    <!-- HOME - Live URL -->
    <div id="view-home" class="project active">
      <iframe 
        src="https://app.smartsheet.eu/b/publish?EQBCT=d75deb97e5c544d98de6b1b5c4c6f2b6" 
        loading="eager" 
        fetchpriority="high"
        importance="high"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope"
        referrerpolicy="no-referrer"></iframe>
    </div>

    <!-- VM13 -->
    <div id="view-vm13" class="project inactive">
      <div class="slides">
        <div class="slide active"><img src="snapshots/2025-09/VM 13.0/Dashboard-1.png" alt="VM13 Dashboard 1" loading="eager"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-2.png" alt="VM13 Dashboard 2"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-3.png" alt="VM13 Dashboard 3"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-4.png" alt="VM13 Dashboard 4"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-5.png" alt="VM13 Dashboard 5"></div>
      </div>
      <div class="controls"><button class="btn prev">⟨ Prev</button><div class="counter">1 / 5</div><button class="btn next">Next ⟩</button></div>
    </div>

    <!-- Blaze -->
    <div id="view-blaze" class="project inactive">
      <div class="slides">
        <div class="slide active"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-1.png" alt="Blaze Dashboard 1" loading="eager"></div>
        <div class="slide"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-2.png" alt="Blaze Dashboard 2"></div>
        <div class="slide"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-3.png" alt="Blaze Dashboard 3"></div>
        <div class="slide"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-4.png" alt="Blaze Dashboard 4"></div>
      </div>
      <div class="controls"><button class="btn prev">⟨ Prev</button><div class="counter">1 / 4</div><button class="btn next">Next ⟩</button></div>
    </div>

    <!-- VM14 -->
    <div id="view-vm14" class="project inactive">
      <div class="slides">
        <div class="slide active"><img src="snapshots/2025-09/VM 14.0/Dashboard-1.png" alt="VM14 Dashboard 1" loading="eager"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-2.png" alt="VM14 Dashboard 2"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-3.png" alt="VM14 Dashboard 3"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-4.png" alt="VM14 Dashboard 4"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-5.png" alt="VM14 Dashboard 5"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-6.png" alt="VM14 Dashboard 6"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-7.png" alt="VM14 Dashboard 7"></div>
      </div>
      <div class="controls"><button class="btn prev">⟨ Prev</button><div class="counter">1 / 7</div><button class="btn next">Next ⟩</button></div>
    </div>
  </div>

 <script>
  // Constants  
  const WORKFLOW_PAT_NEW = '${{ secrets.WORKFLOW_PAT_NEW }}';  // Will be replaced during build
  const SPLASH_TIMEOUT = 3000;  // Maximum splash screen wait time
  
  const ROUTES = ['home', 'vm13', 'blaze', 'vm14'];
  const CONTAINERS = ROUTES.reduce((acc, route) => {
    acc[route] = document.getElementById(`view-${route}`);
    return acc;
  }, {});

  let currentSliders = {};

  function show(route){
    ROUTES.forEach(r=>{
      const el=CONTAINERS[r];if(!el)return;
      if(r===route){
        el.classList.add('active');
        el.classList.remove('inactive');
        // Initialize slider for this route if it hasn't been yet
        if(r !== 'home' && !currentSliders[r]) {
          setupSlider(el);
        }
      } else {
        el.classList.remove('active');
        el.classList.add('inactive');
      }
    });
    if(location.hash.replace('#','')!==route)location.hash=route;
  }



  function setupSlider(project) {
    if (project.id === 'view-home') return;
    
    const slides = Array.from(project.querySelectorAll('.slide'));
    const [prev, next] = project.querySelectorAll('.btn');
    const counter = project.querySelector('.counter');
    if (!slides.length) return;

    let currentIndex = 0;

    function updateSlides() {
      slides.forEach((s, i) => s.classList.toggle('active', i === currentIndex));
      counter.textContent = `${currentIndex + 1} / ${slides.length}`;
      prev.disabled = currentIndex === 0;
      next.disabled = currentIndex === slides.length - 1;
    }

    prev.onclick = () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateSlides();
      }
    };

    next.onclick = () => {
      if (currentIndex < slides.length - 1) {
        currentIndex++;
        updateSlides();
      }
    };

    updateSlides();
    currentSliders[project.id.replace('view-', '')] = { currentIndex, slides };
  }

  function setupSliders() {
    document.querySelectorAll('.project').forEach(setupSlider);
  }

  // Initialize on page load
  window.addEventListener('load', () => {
    const splash = document.getElementById('splash');
    const veil = document.getElementById('veil');
    const topbar = document.getElementById('topbar');
    const stage = document.getElementById('stage');
    const homeIframe = document.querySelector('#view-home iframe');

    function showUI() {
      veil?.classList.add('hidden');
      topbar.style.opacity = '1';
      stage.style.opacity = '1';
    }

    function removeSplash() {
      splash?.classList.add('fade-out');
      setTimeout(() => {
        splash?.remove();
        veil?.remove();
        showUI();
      }, 400);
    }

    // Handle home iframe load
    if (homeIframe) {
      homeIframe.addEventListener('load', removeSplash, { once: true });
    }

    // Fallback
    setTimeout(removeSplash, SPLASH_TIMEOUT);

    // Set initial route
    const initialRoute = location.hash.slice(1) || 'home';
    updateNavSelection(initialRoute);
    setupSliders();
  });

  function updateNavSelection(route){
    document.querySelectorAll('.top a.btn[data-route]').forEach(a=>{
      const is = a.dataset.route===route;
      a.classList.toggle('selected', is);
      if(is) a.setAttribute('aria-current','page'); else a.removeAttribute('aria-current');
    });
  }

  document.querySelectorAll('.top a.btn[data-route]').forEach(a=>{
    a.addEventListener('click',e=>{
      e.preventDefault();
      show(a.dataset.route);
      updateNavSelection(a.dataset.route);
    });
  });

  window.addEventListener('hashchange',()=>{
    const r=(location.hash||'#home').replace('#','');
    const route = ROUTES.includes(r)?r:'home';
    show(route);
    updateNavSelection(route);
  });

  function showDashboard(project) {
    show(project);
    updateNavSelection(project);
  }

  // Improved refreshDashboards: use Actions Jobs API to compute progress, enforce monotonic progress,
  // prevent concurrent pollers per project, and resume correctly.
  const REPO_API_BASE = 'https://api.github.com/repos/Abhinav-PIC/NPI-Dashboards';
  const __dashboardPollers = window.__dashboardPollers || (window.__dashboardPollers = {});

  async function refreshDashboards(project) {
    const overlay = document.getElementById('refresh-overlay');
    const messageEl = overlay.querySelector('.message');
    const progressBar = overlay.querySelector('.progress-bar');
    const statusEl = overlay.querySelector('.status');
    overlay.classList.add('active');
    overlay.onclick = null;

    const storageKey = 'current_workflow_update';
    let stored = null;
    try { stored = JSON.parse(localStorage.getItem(storageKey) || 'null'); } catch(e) { stored = null; }

    // Prevent starting a second poller for the same project
    if (__dashboardPollers[project]?.active) {
      messageEl.textContent = 'Update already in progress...';
      statusEl.textContent = `Tracking ${project}`;
      return;
    }

    // Track monotonic progress
    let lastProgress = 0;
    const setProgress = (percent, message, status) => {
      const safe = Math.max(lastProgress, Math.min(100, Math.round(percent || 0)));
      lastProgress = safe;
      progressBar.style.width = `${safe}%`;
      if (message) messageEl.textContent = message;
      if (status) statusEl.textContent = status;
    };

    const apiFetch = (url, opts = {}) => fetch(url, Object.assign({}, opts, { headers: Object.assign({}, (opts.headers || {}), { 'Accept': 'application/vnd.github.v3+json', 'Authorization': `Bearer ${WORKFLOW_PAT_NEW}` }) }));

    try {
      if (!WORKFLOW_PAT_NEW || WORKFLOW_PAT_NEW === '${{ secrets.WORKFLOW_PAT_NEW }}') throw new Error('GitHub token not properly configured');

      const fullProjectName = (typeof project === 'string') ? project.replace(/^\s+|\s+$/g, '').replace(/^['"]|['"]$/g, '') : project;
      if (!['VM 13.0','Blaze 1.0','VM 14.0'].includes(fullProjectName)) throw new Error(`Invalid project name: ${fullProjectName}`);

      // If we have a stored run and it's recent, try to resume it
      if (stored && stored.project === fullProjectName && (Date.now() - (stored.timestamp || 0)) < (1000 * 60 * 60) && stored.runId) {
        setProgress(20, 'Resuming workflow...', `Resuming ${stored.project}`);
      } else {
        // Start a new repository_dispatch
        setProgress(10, 'Initializing workflow...', 'Starting update process');
        const dispatchResp = await fetch(`${REPO_API_BASE}/dispatches`, {
          method: 'POST',
          headers: { 'Accept': 'application/vnd.github.v3+json', 'Authorization': `Bearer ${WORKFLOW_PAT_NEW}`, 'Content-Type': 'application/json', 'X-GitHub-Api-Version': '2022-11-28' },
          body: JSON.stringify({ event_type: 'repository_dispatch', client_payload: { project: fullProjectName } })
        });

        if (!dispatchResp.ok && dispatchResp.status !== 204) {
          const errText = await dispatchResp.text();
          throw new Error(`GitHub dispatch failed: ${dispatchResp.status} ${errText}`);
        }

        stored = { project: fullProjectName, timestamp: Date.now(), runId: stored?.runId || null };
        localStorage.setItem(storageKey, JSON.stringify(stored));
        setProgress(20, 'Workflow dispatched', 'Awaiting workflow run...');
      }

      // mark poller active
      __dashboardPollers[project] = { active: true };

      // Poll for the run id (if we don't have one yet) and then poll run/jobs to compute progress
      let runId = stored?.runId || null;
      const maxPolls = 60; // ~5 minutes with 5s waits
      for (let attempt = 0; attempt < maxPolls && __dashboardPollers[project].active; attempt++) {
        await new Promise(r => setTimeout(r, 5000));

        try {
          if (!runId) {
            // get latest runs triggered by repository_dispatch
            const runsResp = await apiFetch(`${REPO_API_BASE}/actions/runs?event=repository_dispatch&per_page=5`);
            if (!runsResp.ok) throw new Error('Failed to list workflow runs');
            const runsJson = await runsResp.json();
            const candidate = (runsJson.workflow_runs || []).find(r => new Date(r.created_at).getTime() >= (stored?.timestamp || 0));
            if (candidate) {
              runId = candidate.id;
              stored.runId = runId;
              stored.timestamp = Date.now();
              localStorage.setItem(storageKey, JSON.stringify(stored));
              setProgress(30, 'Workflow started', 'Capturing latest data...');
            } else {
              // still waiting for run to appear
              setProgress(Math.min(lastProgress + 1, 35), 'Waiting for workflow to start...', 'In queue');
              continue;
            }
          }

          // fetch run details
          const runResp = await apiFetch(`${REPO_API_BASE}/actions/runs/${runId}`);
          if (!runResp.ok) throw new Error('Failed to fetch workflow run');
          const runJson = await runResp.json();

          // If run completed, handle conclusion
          if (runJson.status === 'completed') {
            if (runJson.conclusion === 'success') {
              setProgress(100, 'Update complete!', 'Refreshing...');
              localStorage.removeItem(storageKey);
              __dashboardPollers[project].active = false;
              setTimeout(() => window.location.reload(), 1000);
              return;
            } else {
              // cancelled or failure
              throw new Error(`Update ${runJson.conclusion || 'failed'}`);
            }
          }

          // Run is in_progress or queued. Use jobs/steps to compute a reliable progress percentage
          const jobsResp = await apiFetch(`${REPO_API_BASE}/actions/runs/${runId}/jobs?per_page=100`);
          if (!jobsResp.ok) {
            // fallback to conservative progress based on status
            setProgress(Math.max(lastProgress, 40), 'Updating dashboards...', 'In progress');
            continue;
          }
          const jobsJson = await jobsResp.json();
          const jobs = jobsJson.jobs || [];

          // Sum steps across jobs
          let totalSteps = 0;
          let completedSteps = 0;
          for (const job of jobs) {
            if (Array.isArray(job.steps) && job.steps.length) {
              totalSteps += job.steps.length;
              completedSteps += job.steps.filter(s => s.status === 'completed').length;
            } else {
              // If steps are not present, consider job complete if status==completed
              totalSteps += 1;
              if (job.status === 'completed') completedSteps += 1;
            }
          }

          // compute a percent between 30..95 while running to leave headroom for queue/finish
          const base = 30; // initial work
          const headroom = 65;
          let computed = totalSteps > 0 ? base + (completedSteps / totalSteps) * headroom : base;
          computed = Math.min(95, computed);
          setProgress(computed, 'Updating dashboards...', `Processing ${completedSteps}/${totalSteps} steps`);

          // continue polling until completed
        } catch (innerErr) {
          console.error('Poll error:', innerErr);
          // don't decrease progress on transient errors; show a message
          setProgress(Math.max(lastProgress, 40), 'Checking workflow status...', 'Retrying...');
        }
      }

      // timed out
      throw new Error('Update timed out');
    } catch (error) {
      console.error('Error:', error);
      // determine type
      const message = (error && error.message || '').toLowerCase();
      const isCancelled = message.includes('cancel') || message.includes('cancelled');
      const isFailed = message.includes('failed') || message.includes('timed out') || message.includes('error');

      // clear stored state
      localStorage.removeItem(storageKey);
      if (__dashboardPollers[project]) __dashboardPollers[project].active = false;

      messageEl.textContent = isCancelled ? '⚠️ Update Cancelled' : '⚠️ Update Failed';
      statusEl.style.textAlign = 'center';
      statusEl.innerHTML = 'Please contact support<br><span style="display: block">(Click anywhere to dismiss)</span>';
      progressBar.style.width = '100%';
      progressBar.style.background = isCancelled ? '#f0ad4e' : '#ff6b6b';
      overlay.onclick = () => {
        overlay.classList.remove('active');
        progressBar.style.background = 'var(--philips)';
      };
    } finally {
      if (__dashboardPollers[project]) __dashboardPollers[project].active = false;
    }
  }

  // Resume polling only if there's a stored run and no active poller
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      const stored = (() => { try { return JSON.parse(localStorage.getItem('current_workflow_update') || 'null'); } catch (e) { return null; } })();
      if (stored && stored.project && (!__dashboardPollers[stored.project] || !__dashboardPollers[stored.project].active)) {
        refreshDashboards(stored.project);
      }
    }
  });
</script>

</body>
</html>