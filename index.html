<!doctype html>
<html lang="en">
<head>
  <!-- Performance optimizations for Smartsheet -->
  <link rel="preconnect" href="https://app.smartsheet.eu" crossorigin>
  <link rel="dns-prefetch" href="https://app.smartsheet.eu">
  <link rel="preconnect" href="https://webappassets.smartsheet.eu" crossorigin>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>NPI Dashboards</title>
  <style>
    :root{
      --philips:#0e5fd8;
      --bar:#0b2b4f;
      --btn:#003366;
      --btnH:#0059b3;
      --btnDis:#7a94b8;
      --warning:#ffcc00;
    }

    html,body{margin:0;height:100%;overflow:hidden;background:#fff;font-family:"Segoe UI","Helvetica Neue",Arial,sans-serif;}

    /* Veil */
    .veil{position:fixed;inset:0;background:#fff;opacity:1;transition:opacity .6s ease;pointer-events:none;z-index:9998;}
    .veil.hidden{opacity:0}

    /* Splash */
    .splash{position:fixed;inset:0;background:var(--philips);z-index:9999;color:#fff}
    .splash-fit{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:center}
    .splash-inner{display:flex;flex-direction:column;align-items:center;gap:14px}
    .splash-logo{font-weight:900;letter-spacing:.04em;font-size:clamp(66px,14vw,180px);line-height:1.02;white-space:nowrap;
      opacity:0;transform:translateY(14px);
      animation:logoIn .5s ease-out .2s forwards,logoOut .5s ease-in 2.0s forwards;}
    .splash-tag{display:flex;align-items:center;font-size:clamp(28px,3vw,46px);font-weight:700;gap:.35ch;
      opacity:0;transform:translateX(64px);
      animation:tagSlide .8s ease-out .9s forwards,tagFade .5s ease-in 2.0s forwards;}
    /* Center loading line */
    .loading{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#fff;font-weight:800;font-size:clamp(20px,3.6vw,36px);opacity:0;text-align:center;pointer-events:none;white-space:nowrap}
    .loading .dots{display:inline-flex;gap:.28ch;margin-left:.5ch;font-size:0.9em}
    .loading .dots span{opacity:.25;display:inline-block;animation:dotPulse 1s infinite ease-in-out}
    .loading .dots span:nth-child(1){animation-delay:0s}
    .loading .dots span:nth-child(2){animation-delay:.15s}
    .loading .dots span:nth-child(3){animation-delay:.3s}
    @keyframes dotPulse{0%,100%{opacity:.25}50%{opacity:1}}
    .loading{animation:loadingIn .42s cubic-bezier(.22,.9,.35,1) 2.5s forwards}
    @keyframes loadingIn{from{opacity:0;transform:translate(-50%,-55%)}to{opacity:1;transform:translate(-50%,-50%)}}
    @media (max-width:420px){.loading{font-size:clamp(18px,5.5vw,28px)}}

    .sparkles{position:relative;width:1.25em;height:1.25em;display:inline-block;margin:0 .08em}
    .sparkles svg{position:absolute;inset:0;width:100%;height:100%;fill:#fff}
    .sparkles .back{opacity:.45;transform:translate(.18em,-.14em) scale(.78)}
    .sparkles .front{opacity:1}
    .splash.fade-out{animation:fadeSplash .8s ease-in forwards}

    @keyframes logoIn{to{opacity:1;transform:translateY(0)}}
    @keyframes logoOut{to{opacity:0;transform:translateY(-20px)}}
    @keyframes tagSlide{to{opacity:1;transform:translateX(0)}}
    @keyframes tagFade{to{opacity:0;transform:translateX(-20px)}}
    @keyframes fadeSplash{to{opacity:0;visibility:hidden}}

    .sparkles{position:relative;width:1.25em;height:1.25em;display:inline-block;margin:0 .08em}
    .sparkles svg{position:absolute;inset:0;width:100%;height:100%;fill:#fff}
    .sparkles .back{opacity:.45;transform:translate(.18em,-.14em) scale(.78)}
    .sparkles .front{opacity:1}
    .splash.fade-out{animation:fadeSplash .8s ease-in forwards}

    @keyframes logoIn{to{opacity:1;transform:translateY(0)}}
    @keyframes logoOut{to{opacity:0;transform:translateY(-20px)}}
    @keyframes tagSlide{to{opacity:1;transform:translateX(0)}}
    @keyframes tagFade{to{opacity:0;transform:translateX(-20px)}}
    @keyframes fadeSplash{to{opacity:0;visibility:hidden}}

    /* Refresh Overlay */
    .refresh-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      z-index: 9999;
      padding: 20px;
    }

    .refresh-overlay.active {
      display: flex;
    }

    .refresh-overlay .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--philips);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .refresh-overlay .message {
      font-size: 1.2em;
      text-align: center;
      max-width: 80%;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .refresh-overlay .progress-container {
      width: 300px;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
      margin: 20px 0;
    }

    .refresh-overlay .progress-bar {
      width: 0%;
      height: 100%;
      background: var(--philips);
      transition: width 0.5s ease;
    }

    .refresh-overlay .status {
      font-size: 0.9em;
      color: rgba(255,255,255,0.8);
      margin-top: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Top bar and Navigation */
    .top{
      position:fixed;
      inset:0 0 auto 0;
      height:56px;
      display:flex;
      gap:10px;
      align-items:center;
      padding:0 14px;
      background:var(--bar);
      color:#fff;
      z-index:100;
      opacity:0;
      transition:opacity 1s ease
    }

    /* Dropdown Menu */
    .nav-item {
      position: relative;
      display: inline-block;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--bar);
      border-radius: 8px;
      padding: 8px;
      min-width: 220px;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
      z-index: 1000;
      margin-top: 2px;
    }

    /* Add padding to create hoverable area between button and dropdown */
    .nav-item::after {
      content: '';
      position: absolute;
      height: 10px;
      left: 0;
      right: 0;
      bottom: -10px;
    }

    /* Show dropdown on hover and keep it visible while hovering the gap */
    .nav-item:hover .dropdown {
      display: block;
      animation: fadeIn 0.1s ease-out;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      transition: background .15s ease-in-out;
      font-weight: 500;
      white-space: nowrap;
    }

    .dropdown-item:hover {
      background: var(--btnH);
    }

    .dropdown-item svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
      flex-shrink: 0;
    }

    .dropdown-item.refresh-button {
      color: var(--warning);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .btn{display:inline-block;border:0;border-radius:12px;padding:8px 14px;font-weight:700;color:#fff;background:#104071;text-decoration:none}
    .btn{transition:transform .12s ease, box-shadow .12s ease, background-color .12s ease}
    .btn:active{transform:translateY(1px) scale(.995); box-shadow:inset 0 2px 6px rgba(0,0,0,.25); background:var(--btnH)}
    .top a.btn:hover{background:var(--btnH)}
    .top a.btn.selected{background:#fff;color:var(--bar);box-shadow:0 6px 20px rgba(0,0,0,.18)}

    /* Stage */
    .stage{position:absolute;inset:56px 0 0 0;opacity:0;transition:opacity .6s ease}
    iframe{width:100%;height:100%;border:0;background:#fff}
    .slide {
      overflow-y: auto;
      overflow-x: hidden;
    }
    .slide img {
      width: 100%;
      height: auto;
      display: block;
      background: #fff;
    }

    /* Project containers */
    .project{position:absolute;inset:0;transition:opacity .3s ease}
    .project.inactive{opacity:0;z-index:0;pointer-events:none}
    .project.active{opacity:1;z-index:1;pointer-events:auto}

    /* Slider */
    .slides{position:absolute;inset:0}
    .slide{
      position:absolute;
      inset:0;
      opacity:0;
      pointer-events:none;
      transition:opacity 0.3s ease;
      height: 100%;
      overflow-y: auto;
    }
    .slide.active{
      opacity:1;
      pointer-events:auto;
      z-index:1;
    }
    .controls{position:absolute;left:0;right:0;bottom:18px;display:flex;justify-content:space-between;align-items:center;padding:0 22px;z-index:30}
    .controls .btn{padding:10px 16px;font-size:14px;background:var(--btn)}
    .controls .btn:hover{background:var(--btnH)}
    .controls .btn[disabled]{background:var(--btnDis);cursor:not-allowed;opacity:.65}
    .counter{color:#fff;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:8px;font-weight:700}
  </style>
</head>
<body>
  <!-- Refresh Overlay -->
  <div id="refresh-overlay" class="refresh-overlay">
    <div class="spinner"></div>
    <div class="message">Capturing latest dashboard data</div>
    <div class="progress-container">
      <div class="progress-bar"></div>
    </div>
    <div class="status"></div>
  </div>

  <!-- SPLASH -->
  <div id="splash" class="splash">
    <div class="splash-fit">
      <div class="splash-inner">
        <div class="splash-logo">PHILIPS</div>
        <div class="splash-tag">
          <span>innovation</span>
          <span class="sparkles">
            <svg class="back" viewBox="0 0 24 24"><path d="M12 2l1.8 5.4L19 9.5l-5.2 1.7L12 16l-1.8-4.8L5 9.5l5.2-2.1L12 2z"/></svg>
            <svg class="front" viewBox="0 0 24 24"><path d="M12 2l1.8 5.4L19 9.5l-5.2 1.7L12 16l-1.8-4.8L5 9.5l5.2-2.1L12 2z"/></svg>
          </span>
          <span>you</span>
        </div>
        <div id="splash-loading" class="loading" aria-hidden="true">
          <span>Loading NPI Dashboards</span>
          <span class="dots"><span>.</span><span>.</span><span>.</span></span>
        </div>
      </div>
    </div>
  </div>
  <div class="veil" id="veil"></div>

  <!-- NAVIGATION -->
  <div class="top" id="topbar">
    <a class="btn" href="#home" data-route="home">Home</a>
    
    <div class="nav-item">
      <a class="btn" href="#vm13" data-route="vm13">VM 13.0</a>
      <div class="dropdown">
  <a class="dropdown-item refresh-button" href="#" onclick="refreshDashboards('VM 13.0')">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Refresh Dashboards
        </a>
        <a class="dropdown-item edit-button" href="https://app.smartsheet.eu/workspaces/W7JvM9F6XMVhxv7ffw4rVJfg4CM7xgfxjPC5JHf1" target="_blank">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Edit Data
        </a>
      </div>
    </div>

    <div class="nav-item">
      <a class="btn" href="#blaze" data-route="blaze">Blaze 1.0</a>
      <div class="dropdown">
  <a class="dropdown-item refresh-button" href="#" onclick="refreshDashboards('Blaze 1.0')">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Refresh Dashboards
        </a>
        <a class="dropdown-item edit-button" href="https://app.smartsheet.eu/workspaces/MP68x2GxfFg79xcqvJhFw5hjhGQQ9j7G5G3QXQh1" target="_blank">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Edit Data
        </a>
      </div>
    </div>

    <div class="nav-item">
      <a class="btn" href="#vm14" data-route="vm14">VM 14.0</a>
      <div class="dropdown">
  <a class="dropdown-item refresh-button" href="#" onclick="refreshDashboards('VM 14.0')">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Refresh Dashboards
        </a>
        <a class="dropdown-item edit-button" href="https://app.smartsheet.eu/workspaces/gM9wv3Rqwphqjj6hj4gHrGfPmrJWMFhhfCf7X6G1" target="_blank">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Edit Data
        </a>
      </div>
    </div>
    
    <div class="spacer"></div>
  </div>

  <!-- DASHBOARDS -->
  <div class="stage" id="stage">
    <!-- HOME - Live URL -->
    <div id="view-home" class="project active">
      <iframe 
        src="https://app.smartsheet.eu/b/publish?EQBCT=d75deb97e5c544d98de6b1b5c4c6f2b6" 
        loading="eager" 
        fetchpriority="high"
        importance="high"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope"
        referrerpolicy="no-referrer"></iframe>
    </div>

    <!-- VM13 -->
    <div id="view-vm13" class="project inactive">
      <div class="slides">
        <div class="slide active"><img src="snapshots/2025-09/VM 13.0/Dashboard-1.png" alt="VM13 Dashboard 1" loading="eager"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-2.png" alt="VM13 Dashboard 2"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-3.png" alt="VM13 Dashboard 3"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-4.png" alt="VM13 Dashboard 4"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-5.png" alt="VM13 Dashboard 5"></div>
      </div>
      <div class="controls"><button class="btn prev">⟨ Prev</button><div class="counter">1 / 5</div><button class="btn next">Next ⟩</button></div>
    </div>

    <!-- Blaze -->
    <div id="view-blaze" class="project inactive">
      <div class="slides">
        <div class="slide active"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-1.png" alt="Blaze Dashboard 1" loading="eager"></div>
        <div class="slide"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-2.png" alt="Blaze Dashboard 2"></div>
        <div class="slide"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-3.png" alt="Blaze Dashboard 3"></div>
        <div class="slide"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-4.png" alt="Blaze Dashboard 4"></div>
      </div>
      <div class="controls"><button class="btn prev">⟨ Prev</button><div class="counter">1 / 4</div><button class="btn next">Next ⟩</button></div>
    </div>

    <!-- VM14 -->
    <div id="view-vm14" class="project inactive">
      <div class="slides">
        <div class="slide active"><img src="snapshots/2025-09/VM 14.0/Dashboard-1.png" alt="VM14 Dashboard 1" loading="eager"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-2.png" alt="VM14 Dashboard 2"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-3.png" alt="VM14 Dashboard 3"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-4.png" alt="VM14 Dashboard 4"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-5.png" alt="VM14 Dashboard 5"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-6.png" alt="VM14 Dashboard 6"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-7.png" alt="VM14 Dashboard 7"></div>
      </div>
      <div class="controls"><button class="btn prev">⟨ Prev</button><div class="counter">1 / 7</div><button class="btn next">Next ⟩</button></div>
    </div>
  </div>

 <script>
  // Constants  
  const WORKFLOW_PAT_NEW = '${{ secrets.WORKFLOW_PAT_NEW }}';  // Will be replaced during build
  const SPLASH_TIMEOUT = 3000;  // Maximum splash screen wait time
  
  const ROUTES = ['home', 'vm13', 'blaze', 'vm14'];
  const CONTAINERS = ROUTES.reduce((acc, route) => {
    acc[route] = document.getElementById(`view-${route}`);
    return acc;
  }, {});

  let currentSliders = {};

  function show(route){
    ROUTES.forEach(r=>{
      const el=CONTAINERS[r];if(!el)return;
      if(r===route){
        el.classList.add('active');
        el.classList.remove('inactive');
        // Initialize slider for this route if it hasn't been yet
        if(r !== 'home' && !currentSliders[r]) {
          setupSlider(el);
        }
      } else {
        el.classList.remove('active');
        el.classList.add('inactive');
      }
    });
    if(location.hash.replace('#','')!==route)location.hash=route;
  }



  function setupSlider(project) {
    if (project.id === 'view-home') return;
    
    const slides = Array.from(project.querySelectorAll('.slide'));
    const [prev, next] = project.querySelectorAll('.btn');
    const counter = project.querySelector('.counter');
    if (!slides.length) return;

    let currentIndex = 0;

    function updateSlides() {
      slides.forEach((s, i) => s.classList.toggle('active', i === currentIndex));
      counter.textContent = `${currentIndex + 1} / ${slides.length}`;
      prev.disabled = currentIndex === 0;
      next.disabled = currentIndex === slides.length - 1;
    }

    prev.onclick = () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateSlides();
      }
    };

    next.onclick = () => {
      if (currentIndex < slides.length - 1) {
        currentIndex++;
        updateSlides();
      }
    };

    updateSlides();
    currentSliders[project.id.replace('view-', '')] = { currentIndex, slides };
  }

  function setupSliders() {
    document.querySelectorAll('.project').forEach(setupSlider);
  }

  // Initialize on page load
  window.addEventListener('load', () => {
    const splash = document.getElementById('splash');
    const veil = document.getElementById('veil');
    const topbar = document.getElementById('topbar');
    const stage = document.getElementById('stage');
    const homeIframe = document.querySelector('#view-home iframe');

    function showUI() {
      veil?.classList.add('hidden');
      topbar.style.opacity = '1';
      stage.style.opacity = '1';
    }

    function removeSplash() {
      splash?.classList.add('fade-out');
      setTimeout(() => {
        splash?.remove();
        veil?.remove();
        showUI();
      }, 400);
    }

    // Handle home iframe load
    if (homeIframe) {
      homeIframe.addEventListener('load', removeSplash, { once: true });
    }

    // Fallback
    setTimeout(removeSplash, SPLASH_TIMEOUT);

    // Set initial route
    const initialRoute = location.hash.slice(1) || 'home';
    updateNavSelection(initialRoute);
    setupSliders();
  });

  function updateNavSelection(route){
    document.querySelectorAll('.top a.btn[data-route]').forEach(a=>{
      const is = a.dataset.route===route;
      a.classList.toggle('selected', is);
      if(is) a.setAttribute('aria-current','page'); else a.removeAttribute('aria-current');
    });
  }

  document.querySelectorAll('.top a.btn[data-route]').forEach(a=>{
    a.addEventListener('click',e=>{
      e.preventDefault();
      show(a.dataset.route);
      updateNavSelection(a.dataset.route);
    });
  });

  window.addEventListener('hashchange',()=>{
    const r=(location.hash||'#home').replace('#','');
    const route = ROUTES.includes(r)?r:'home';
    show(route);
    updateNavSelection(route);
  });

  function showDashboard(project) {
    show(project);
    updateNavSelection(project);
  }

  async function refreshDashboards(project) {
    const overlay = document.getElementById('refresh-overlay');
    const messageEl = overlay.querySelector('.message');
    const progressBar = overlay.querySelector('.progress-bar');
    const statusEl = overlay.querySelector('.status');
    overlay.classList.add('active');
    overlay.onclick = null;

    // Local storage key for current run
    const workflowKey = 'current_workflow_update';
    const existingWorkflow = localStorage.getItem(workflowKey);

    if (existingWorkflow) {
      try {
        const workflowData = JSON.parse(existingWorkflow);
        const isRecent = Date.now() - workflowData.timestamp < 15 * 60 * 1000; // 15 minutes
        if (isRecent) {
          messageEl.textContent = 'Resuming update...';
          statusEl.textContent = `Continuing update for ${workflowData.project}`;
          progressBar.style.width = '30%';
        } else {
          localStorage.removeItem(workflowKey);
        }
      } catch (e) { localStorage.removeItem(workflowKey); }
    }

    const updateProgress = (percent, message, status, color) => {
      progressBar.style.width = `${percent}%`;
      if (message) messageEl.textContent = message;
      if (status !== undefined) statusEl.textContent = status;
      if (color) progressBar.style.background = color;
    };

    try {
      // Allow a runtime token via URL for local testing: ?token=xxx
      const urlToken = new URLSearchParams(location.search).get('token');
      const token = urlToken || WORKFLOW_PAT_NEW;
      if (!token || token === '${{ secrets.WORKFLOW_PAT_NEW }}') {
        throw new Error('GitHub token not properly configured');
      }

      const fullProjectName = (typeof project === 'string') ? project.trim().replace(/^['"]|['"]$/g, '') : project;
      if (!['VM 13.0','Blaze 1.0','VM 14.0'].includes(fullProjectName)) {
        throw new Error(`Invalid project name: ${fullProjectName}`);
      }

      updateProgress(8, 'Initializing workflow...', 'Starting update process');

      // Trigger repository_dispatch
      console.log('Triggering workflow for project:', fullProjectName);
      const dispatchResp = await fetch('https://api.github.com/repos/Abhinav-PIC/NPI-Dashboards/dispatches', {
        method: 'POST',
        headers: {
          'Accept': 'application/vnd.github.v3+json',
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          'X-GitHub-Api-Version': '2022-11-28'
        },
        body: JSON.stringify({ 
          event_type: 'dashboard_update',  // Match the workflow's types exactly
          client_payload: { 
            project: fullProjectName,
            timestamp: Date.now()
          } 
        })
      });
      
      console.log('Dispatch response status:', dispatchResp.status);

      if (!dispatchResp.ok) {
        const text = await dispatchResp.text();
        throw new Error(`GitHub dispatch failed: ${dispatchResp.status} ${text}`);
      }

      updateProgress(18, 'Installing dependencies...', 'Preparing runner');

      // Poll for the run started by our dispatch. We'll try to find the latest run for this event.
      let runId = null;
      for (let attempt = 0; attempt < 36; attempt++) {
        await new Promise(r => setTimeout(r, 5000));
        const runsResp = await fetch('https://api.github.com/repos/Abhinav-PIC/NPI-Dashboards/actions/runs?event=repository_dispatch&per_page=5', {
          headers: { 'Accept': 'application/vnd.github.v3+json', 'Authorization': `Bearer ${token}` }
        });
        if (!runsResp.ok) continue;
        const runsJson = await runsResp.json();
        const run = (runsJson.workflow_runs || []).find(r => r.head_commit && r.head_commit.message && r.head_commit.message.includes(fullProjectName)) || runsJson.workflow_runs?.[0];
        if (run && run.id) { runId = run.id; break; }
      }

      if (!runId) {
        updateProgress(30, 'Capturing latest data...', 'Waiting for workflow to start');
        throw new Error('Failed to find workflow run');
      }

      // persist run info so we can resume
      localStorage.setItem(workflowKey, JSON.stringify({ id: runId, project: fullProjectName, timestamp: Date.now() }));

      // Helper to fetch jobs & steps for the run and compute progress
      async function fetchRunJobs(runId) {
        const jobsResp = await fetch(`https://api.github.com/repos/Abhinav-PIC/NPI-Dashboards/actions/runs/${runId}/jobs?per_page=100`, {
          headers: { 'Accept': 'application/vnd.github.v3+json', 'Authorization': `Bearer ${token}` }
        });
        if (!jobsResp.ok) throw new Error('Failed to fetch run jobs');
        return jobsResp.json();
      }

      // Main poll loop: use job steps to compute accurate progress and messages
      for (let i = 0; i < 120; i++) {
        await new Promise(r => setTimeout(r, 4000));
        try {
          console.log('Fetching jobs for run:', runId);
          const runJobs = await fetchRunJobs(runId);
          const jobs = runJobs.jobs || [];
          console.log('Found jobs:', jobs.length);

          // Flatten steps and filter ones that look like dashboard capture steps
          const allSteps = [];
          jobs.forEach(job => {
            (job.steps || []).forEach(s => allSteps.push({ jobName: job.name, ...s }));
          });

          // Heuristic: steps that mention "dashboard", "capture", "snapshot", "publish", or "upload"
          const dashSteps = allSteps.filter(s => /dashboard|capture|snapshot|publish|upload/i.test(s.name));
          const totalSteps = dashSteps.length || (fullProjectName === 'VM 14.0' ? 7 : fullProjectName === 'VM 13.0' ? 5 : 4);

          const completed = dashSteps.filter(s => s.conclusion === 'success').length;
          const inProgress = dashSteps.findIndex(s => s.status === 'in_progress');
          const currentIndex = inProgress >= 0 ? inProgress + 1 : (completed < totalSteps ? completed + 1 : totalSteps);

          // Find overall run status from job array
          const runStatus = jobs.some(j => j.status === 'in_progress') ? 'in_progress' : (jobs.every(j => j.conclusion === 'success') ? 'completed' : (jobs.some(j => j.conclusion === 'failure') ? 'failed' : 'queued'));

          // Compute percent: base 20..95 depending on progress
          const percent = runStatus === 'queued' ? 15 : runStatus === 'in_progress' ? Math.min(20 + Math.round((completed / totalSteps) * 70), 95) : runStatus === 'completed' ? 100 : 50;

          const message = runStatus === 'queued' ? 'Waiting for workflow to start...' : runStatus === 'in_progress' ? 'Updating dashboards...' : runStatus === 'completed' ? 'Update complete!' : 'Processing...';
          const statusText = runStatus === 'in_progress' ? `Updating dashboard ${Math.min(currentIndex, totalSteps)}/${totalSteps}` : (runStatus === 'queued' ? 'In queue' : (runStatus === 'completed' ? 'Refreshing page...' : ''));

          updateProgress(percent, message, statusText);

          if (runStatus === 'completed' && jobs.every(j => j.conclusion === 'success')) {
            localStorage.removeItem(workflowKey);
            setTimeout(() => window.location.reload(), 900);
            return;
          }

          if (runStatus === 'failed' || jobs.some(j => j.conclusion === 'failure')) {
            throw new Error('Update failed');
          }

        } catch (err) {
          console.error('Polling error:', err);
          // continue polling a few more times, but show a message
          updateProgress(50, 'Checking status...', 'Encountered a temporary error');
        }
      }

      // timeout
      updateProgress(100, '⚠️ Update Timed Out', 'Please try again', '#f0ad4e');
      localStorage.removeItem(workflowKey);
      throw new Error('Update timed out');

    } catch (error) {
      console.error('Error:', error);
      localStorage.removeItem(workflowKey);
      const msg = (error.message || '').toLowerCase();
      const isCancelled = msg.includes('cancel');
      updateProgress(100, isCancelled ? '⚠️ Update Cancelled' : '⚠️ Update Failed', 'Please contact support', isCancelled ? '#f0ad4e' : '#ff6b6b');
      overlay.onclick = () => { overlay.classList.remove('active'); progressBar.style.background = 'var(--philips)'; };
    }
  }

  // Add page visibility handling
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      const workflowData = localStorage.getItem('current_workflow_update');
      if (workflowData) {
        const { project } = JSON.parse(workflowData);
        refreshDashboards(project); // Resume the update check
      }
    }
  });
</script>

</body>
</html>