<!doctype html>
<html lang="en">
<head>
  <!-- Performance optimizations for Smartsheet -->
  <link rel="preconnect" href="https://app.smartsheet.eu" crossorigin>
  <link rel="dns-prefetch" href="https://app.smartsheet.eu">
  <link rel="preconnect" href="https://webappassets.smartsheet.eu" crossorigin>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>NPI Dashboards</title>
  <style>
    :root{
      --philips:#0e5fd8;
      --bar:#0b2b4f;
      --btn:#003366;
      --btnH:#0059b3;
      --btnDis:#7a94b8;
      --warning:#ffcc00;
    }

    html,body{margin:0;height:100%;overflow:hidden;background:#fff;font-family:"Segoe UI","Helvetica Neue",Arial,sans-serif;}

    /* Veil */
    .veil{position:fixed;inset:0;background:#fff;opacity:1;transition:opacity .6s ease;pointer-events:none;z-index:9998;}
    .veil.hidden{opacity:0}

    /* Splash */
    .splash{position:fixed;inset:0;background:var(--philips);z-index:9999;color:#fff}
    .splash-fit{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:center}
    .splash-inner{display:flex;flex-direction:column;align-items:center;gap:14px}
    .splash-logo{font-weight:900;letter-spacing:.04em;font-size:clamp(66px,14vw,180px);line-height:1.02;white-space:nowrap;
      opacity:0;transform:translateY(14px);
      animation:logoIn .5s ease-out .2s forwards,logoOut .5s ease-in 2.0s forwards;}
    .splash-tag{display:flex;align-items:center;font-size:clamp(28px,3vw,46px);font-weight:700;gap:.35ch;
      opacity:0;transform:translateX(64px);
      animation:tagSlide .8s ease-out .9s forwards,tagFade .5s ease-in 2.0s forwards;}
    /* Center loading line */
    .loading{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#fff;font-weight:800;font-size:clamp(20px,3.6vw,36px);opacity:0;text-align:center;pointer-events:none;white-space:nowrap}
    .loading .dots{display:inline-flex;gap:.28ch;margin-left:.5ch;font-size:0.9em}
    .loading .dots span{opacity:.25;display:inline-block;animation:dotPulse 1s infinite ease-in-out}
    .loading .dots span:nth-child(1){animation-delay:0s}
    .loading .dots span:nth-child(2){animation-delay:.15s}
    .loading .dots span:nth-child(3){animation-delay:.3s}
    @keyframes dotPulse{0%,100%{opacity:.25}50%{opacity:1}}
    .loading{animation:loadingIn .42s cubic-bezier(.22,.9,.35,1) 2.5s forwards}
    @keyframes loadingIn{from{opacity:0;transform:translate(-50%,-55%)}to{opacity:1;transform:translate(-50%,-50%)}}
    @media (max-width:420px){.loading{font-size:clamp(18px,5.5vw,28px)}}

    .sparkles{position:relative;width:1.25em;height:1.25em;display:inline-block;margin:0 .08em}
    .sparkles svg{position:absolute;inset:0;width:100%;height:100%;fill:#fff}
    .sparkles .back{opacity:.45;transform:translate(.18em,-.14em) scale(.78)}
    .sparkles .front{opacity:1}
    .splash.fade-out{animation:fadeSplash .8s ease-in forwards}

    @keyframes logoIn{to{opacity:1;transform:translateY(0)}}
    @keyframes logoOut{to{opacity:0;transform:translateY(-20px)}}
    @keyframes tagSlide{to{opacity:1;transform:translateX(0)}}
    @keyframes tagFade{to{opacity:0;transform:translateX(-20px)}}
    @keyframes fadeSplash{to{opacity:0;visibility:hidden}}

    /* Refresh Overlay */
    .refresh-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      z-index: 9999;
      padding: 20px;
    }

    .refresh-overlay.active {
      display: flex;
    }

    .refresh-overlay .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--philips);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .refresh-overlay .message {
      font-size: 1.2em;
      text-align: center;
      max-width: 80%;
      line-height: 1.5;
    }

    .refresh-overlay .steps {
      text-align: left;
      margin-top: 20px;
    }

    .refresh-overlay .steps li {
      margin: 10px 0;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Top bar and Navigation */
    .top{
      position:fixed;
      inset:0 0 auto 0;
      height:56px;
      display:flex;
      gap:10px;
      align-items:center;
      padding:0 14px;
      background:var(--bar);
      color:#fff;
      z-index:100;
      opacity:0;
      transition:opacity 1s ease
    }

    /* Dropdown Menu */
    .nav-item {
      position: relative;
      display: inline-block;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--bar);
      border-radius: 8px;
      padding: 8px;
      min-width: 220px;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
      z-index: 1000;
      margin-top: 4px;
    }

    .nav-item:hover .dropdown {
      display: block;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      transition: background .2s;
      font-weight: 500;
    }

    .dropdown-item:hover {
      background: var(--btnH);
    }

    .dropdown-item svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    .dropdown-item.refresh-button {
      color: var(--success);
    }

    .dropdown-item.edit-button {
      color: var(--warning);
    }
    .btn{display:inline-block;border:0;border-radius:12px;padding:8px 14px;font-weight:700;color:#fff;background:#104071;text-decoration:none}
    .btn{transition:transform .12s ease, box-shadow .12s ease, background-color .12s ease}
    .btn:active{transform:translateY(1px) scale(.995); box-shadow:inset 0 2px 6px rgba(0,0,0,.25); background:var(--btnH)}
    .top a.btn:hover{background:var(--btnH)}
    .top a.btn.selected{background:#fff;color:var(--bar);box-shadow:0 6px 20px rgba(0,0,0,.18)}

    /* Stage */
    .stage{position:absolute;inset:56px 0 0 0;opacity:0;transition:opacity .6s ease}
    iframe{width:100%;height:100%;border:0;background:#fff}
    .slide {
      overflow-y: auto;
      overflow-x: hidden;
    }
    .slide img {
      width: 100%;
      height: auto;
      display: block;
      background: #fff;
    }

    /* Project containers */
    .project{position:absolute;inset:0;transition:opacity .3s ease}
    .project.inactive{opacity:0;z-index:0;pointer-events:none}
    .project.active{opacity:1;z-index:1;pointer-events:auto}

    /* Slider */
    .slides{position:absolute;inset:0}
    .slide{
      position:absolute;
      inset:0;
      opacity:0;
      pointer-events:none;
      transition:opacity 0.3s ease;
      height: 100%;
      overflow-y: auto;
    }
    .slide.active{
      opacity:1;
      pointer-events:auto;
      z-index:1;
    }
    .controls{position:absolute;left:0;right:0;bottom:18px;display:flex;justify-content:space-between;align-items:center;padding:0 22px;z-index:30}
    .controls .btn{padding:10px 16px;font-size:14px;background:var(--btn)}
    .controls .btn:hover{background:var(--btnH)}
    .controls .btn[disabled]{background:var(--btnDis);cursor:not-allowed;opacity:.65}
    .counter{color:#fff;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:8px;font-weight:700}
  </style>
</head>
<body>
  <!-- Refresh Overlay -->
  <div id="refresh-overlay" class="refresh-overlay">
    <div class="spinner"></div>
    <div class="message">Updating dashboards...</div>
  </div>

  <!-- SPLASH -->
  <div id="splash" class="splash">
    <div class="splash-fit">
      <div class="splash-inner">
        <div class="splash-logo">PHILIPS</div>
        <div class="splash-tag">
          <span>innovation</span>
          <span class="sparkles">
            <svg class="back" viewBox="0 0 24 24"><path d="M12 2l1.8 5.4L19 9.5l-5.2 1.7L12 16l-1.8-4.8L5 9.5l5.2-2.1L12 2z"/></svg>
            <svg class="front" viewBox="0 0 24 24"><path d="M12 2l1.8 5.4L19 9.5l-5.2 1.7L12 16l-1.8-4.8L5 9.5l5.2-2.1L12 2z"/></svg>
          </span>
          <span>you</span>
        </div>
        <div id="splash-loading" class="loading" aria-hidden="true">
          <span>Loading NPI Dashboards</span>
          <span class="dots"><span>.</span><span>.</span><span>.</span></span>
        </div>
      </div>
    </div>
  </div>
  <div class="veil" id="veil"></div>

  <!-- NAVIGATION -->
  <div class="top" id="topbar">
    <a class="btn" href="#home" data-route="home">Home</a>
    
    <div class="nav-item">
      <a class="btn" href="#vm13" data-route="vm13">VM 13.0</a>
      <div class="dropdown">
        <a class="dropdown-item refresh-button" href="#" onclick="refreshDashboards('vm13')">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Refresh Dashboards
        </a>
        <a class="dropdown-item edit-button" href="https://app.smartsheet.eu/workspaces/W7JvM9F6XMVhxv7ffw4rVJfg4CM7xgfxjPC5JHf1" target="_blank">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Edit Data
        </a>
      </div>
    </div>

    <div class="nav-item">
      <a class="btn" href="#blaze" data-route="blaze">Blaze 1.0</a>
      <div class="dropdown">
        <a class="dropdown-item refresh-button" href="#" onclick="refreshDashboards('blaze')">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Refresh Dashboards
        </a>
        <a class="dropdown-item edit-button" href="https://app.smartsheet.eu/workspaces/MP68x2GxfFg79xcqvJhFw5hjhGQQ9j7G5G3QXQh1" target="_blank">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Edit Data
        </a>
      </div>
    </div>

    <div class="nav-item">
      <a class="btn" href="#vm14" data-route="vm14">VM 14.0</a>
      <div class="dropdown">
        <a class="dropdown-item refresh-button" href="#" onclick="refreshDashboards('vm14')">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Refresh Dashboards
        </a>
        <a class="dropdown-item edit-button" href="https://app.smartsheet.eu/workspaces/gM9wv3Rqwphqjj6hj4gHrGfPmrJWMFhhfCf7X6G1" target="_blank">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
          Edit Data
        </a>
      </div>
    </div>
    
    <div class="spacer"></div>
  </div>

  <!-- DASHBOARDS -->
  <div class="stage" id="stage">
    <!-- HOME - Live URL -->
    <div id="view-home" class="project active">
      <iframe 
        src="https://app.smartsheet.eu/b/publish?EQBCT=d75deb97e5c544d98de6b1b5c4c6f2b6" 
        loading="eager" 
        fetchpriority="high"
        importance="high"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope"
        referrerpolicy="no-referrer"></iframe>
    </div>

    <!-- VM13 -->
    <div id="view-vm13" class="project inactive">
      <div class="slides">
        <div class="slide active"><img src="snapshots/2025-09/VM 13.0/Dashboard-1.png" alt="VM13 Dashboard 1" loading="eager"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-2.png" alt="VM13 Dashboard 2"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-3.png" alt="VM13 Dashboard 3"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-4.png" alt="VM13 Dashboard 4"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 13.0/Dashboard-5.png" alt="VM13 Dashboard 5"></div>
      </div>
      <div class="controls"><button class="btn prev">⟨ Prev</button><div class="counter">1 / 5</div><button class="btn next">Next ⟩</button></div>
    </div>

    <!-- Blaze -->
    <div id="view-blaze" class="project inactive">
      <div class="slides">
        <div class="slide active"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-1.png" alt="Blaze Dashboard 1" loading="eager"></div>
        <div class="slide"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-2.png" alt="Blaze Dashboard 2"></div>
        <div class="slide"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-3.png" alt="Blaze Dashboard 3"></div>
        <div class="slide"><img src="snapshots/2025-09/Blaze 1.0/Dashboard-4.png" alt="Blaze Dashboard 4"></div>
      </div>
      <div class="controls"><button class="btn prev">⟨ Prev</button><div class="counter">1 / 4</div><button class="btn next">Next ⟩</button></div>
    </div>

    <!-- VM14 -->
    <div id="view-vm14" class="project inactive">
      <div class="slides">
        <div class="slide active"><img src="snapshots/2025-09/VM 14.0/Dashboard-1.png" alt="VM14 Dashboard 1" loading="eager"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-2.png" alt="VM14 Dashboard 2"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-3.png" alt="VM14 Dashboard 3"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-4.png" alt="VM14 Dashboard 4"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-5.png" alt="VM14 Dashboard 5"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-6.png" alt="VM14 Dashboard 6"></div>
        <div class="slide"><img src="snapshots/2025-09/VM 14.0/Dashboard-7.png" alt="VM14 Dashboard 7"></div>
      </div>
      <div class="controls"><button class="btn prev">⟨ Prev</button><div class="counter">1 / 7</div><button class="btn next">Next ⟩</button></div>
    </div>
  </div>

 <script>
  // Constants
  const MIN_SPLASH_MS = 1000;  // Minimum splash screen time
  const MAX_SPLASH_MS = 5000;  // Maximum splash screen time
  
  // GitHub repository details
  const owner = 'Abhinav-PIC';
  const repo = 'NPI-Dashboards';
  const WORKFLOW_PAT_NEW = '${{ secrets.WORKFLOW_PAT_NEW }}';  // Will be replaced during build
  
  const ROUTES=['home','vm13','blaze','vm14'];
  const CONTAINERS={
    home:document.getElementById('view-home'),
    vm13:document.getElementById('view-vm13'),
    blaze:document.getElementById('view-blaze'),
    vm14:document.getElementById('view-vm14'),
  };

  let currentSliders = {};

  function show(route){
    ROUTES.forEach(r=>{
      const el=CONTAINERS[r];if(!el)return;
      if(r===route){
        el.classList.add('active');
        el.classList.remove('inactive');
        // Initialize slider for this route if it hasn't been yet
        if(r !== 'home' && !currentSliders[r]) {
          setupSlider(el);
        }
      } else {
        el.classList.remove('active');
        el.classList.add('inactive');
      }
    });
    if(location.hash.replace('#','')!==route)location.hash=route;
  }



  function setupSlider(project) {
    if (project.id === 'view-home') return null; // Skip home view
    
    const slides = Array.from(project.querySelectorAll('.slide'));
    const counter = project.querySelector('.counter');
    const prev = project.querySelector('.prev');
    const next = project.querySelector('.next');

    if (!slides.length || !prev || !next || !counter) return null;

    const slider = {
      currentIndex: 0,
      slides,
      counter,
      prev,
      next,

      updateSlides() {
        // Hide all slides first
        this.slides.forEach(slide => slide.classList.remove('active'));
        // Show current slide
        this.slides[this.currentIndex].classList.add('active');
        // Update counter
        this.counter.textContent = `${this.currentIndex + 1} / ${this.slides.length}`;
        // Update button states
        this.prev.disabled = this.currentIndex === 0;
        this.next.disabled = this.currentIndex === this.slides.length - 1;
      },

      prevSlide() {
        if (this.currentIndex > 0) {
          this.currentIndex--;
          this.updateSlides();
        }
      },

      nextSlide() {
        if (this.currentIndex < this.slides.length - 1) {
          this.currentIndex++;
          this.updateSlides();
        }
      }
    };

    // Set up event listeners
    prev.onclick = () => slider.prevSlide();
    next.onclick = () => slider.nextSlide();

    // Initialize first view
    slider.updateSlides();
    
    // Store the slider reference
    const projectId = project.id.replace('view-', '');
    currentSliders[projectId] = slider;
    
    return slider;
  }

  function setupSliders() {
    document.querySelectorAll('.project').forEach(project => {
      if (project.id !== 'view-home') {
        setupSlider(project);
      }
    });
  }

  // SPLASH CONTROL – end when Home iframe is live (after min), then warm start others, then preload rest
  window.addEventListener('load',()=>{
    const splash = document.getElementById('splash');
    const veil = document.getElementById('veil');
    const topbar = document.getElementById('topbar');
    const stage = document.getElementById('stage');
    const homeIframe = document.querySelector('#view-home iframe');

    function removeSplash() {
      splash?.classList.add('fade-out');
      setTimeout(() => {
        splash?.remove();
        veil?.classList.add('hidden');
        setTimeout(() => {
          veil?.remove();
          topbar.style.opacity = '1';
          stage.style.opacity = '1';
        }, 300);
      }, 400);
    }

    // Setup Smartsheet loading optimization
    if (homeIframe) {
      // Remove splash as soon as home starts rendering
      homeIframe.addEventListener('load', removeSplash, { once: true });
      
      // Handle Smartsheet specific loading
      homeIframe.onload = () => {
        try {
          const iframeDoc = homeIframe.contentDocument || homeIframe.contentWindow.document;
          if (iframeDoc) {
            // Remove any Smartsheet loading overlays
            const loadingElements = iframeDoc.querySelectorAll('.loading-overlay, .loading-screen');
            loadingElements.forEach(el => el.remove());
          }
        } catch (e) { /* Cross-origin restrictions might prevent this */ }
      };

      // Faster fallback
      setTimeout(removeSplash, 3000);
    }

    function endSplash(force=false){
      if(splashEnded) return; splashEnded=true;
      if(force){
        splash?.remove(); veil?.remove();
        topbar.style.opacity='1'; stage.style.opacity='1';
        return;
      }
      splash.classList.add('fade-out');
      setTimeout(()=>{
        splash.remove();
        veil.classList.add('hidden');
        setTimeout(()=>{
          veil.remove();
          topbar.style.opacity='1';
          stage.style.opacity='1';
        },600);
      },800);
    }

    // Min timer
    setTimeout(()=>{minDone=true;if(homeLoaded) endSplash();},MIN_SPLASH_MS);

    // Home readiness → hide splash + warm-start + then preload rest
    let warmFallback = setTimeout(()=>{ warmStartFirstDashboards(); setTimeout(roundRobinPreload,300); }, 2000);
    if(homeIframe){
      homeIframe.addEventListener('load',()=>{
        homeLoaded=true;
        if(minDone) endSplash();
        clearTimeout(warmFallback);
        warmStartFirstDashboards();
        setTimeout(roundRobinPreload,300);
      },{once:true});
    }

    // Absolute fallback
    setTimeout(()=>endSplash(true),MAX_SPLASH_MS);

    // set initial nav selection
    const initialRoute = (location.hash||'#home').replace('#','') || 'home';
    updateNavSelection(initialRoute);

    setupSliders();
  });

  function updateNavSelection(route){
    document.querySelectorAll('.top a.btn[data-route]').forEach(a=>{
      const is = a.dataset.route===route;
      a.classList.toggle('selected', is);
      if(is) a.setAttribute('aria-current','page'); else a.removeAttribute('aria-current');
    });
  }

  document.querySelectorAll('.top a.btn[data-route]').forEach(a=>{
    a.addEventListener('click',e=>{
      e.preventDefault();
      show(a.dataset.route);
      updateNavSelection(a.dataset.route);
    });
  });

  window.addEventListener('hashchange',()=>{
    const r=(location.hash||'#home').replace('#','');
    const route = ROUTES.includes(r)?r:'home';
    show(route);
    updateNavSelection(route);
  });

  function showDashboard(project) {
    show(project);
    updateNavSelection(project);
  }

  async function refreshDashboards(project) {
    const overlay = document.getElementById('refresh-overlay');
    overlay.querySelector('.message').textContent = `Starting dashboard refresh for ${project.toUpperCase()}...`;
    overlay.classList.add('active');

    try {
      const response = await fetch('https://api.github.com/repos/Abhinav-PIC/NPI-Dashboards/dispatches', {
        method: 'POST',
        headers: {
          'Accept': 'application/vnd.github.v3+json',
          'Authorization': `Bearer ${WORKFLOW_PAT_NEW}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          event_type: 'repository_dispatch',
          client_payload: {
            project: project
          }
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Update failed:', response.status, errorText);
        throw new Error(`Update failed: ${response.status} ${errorText}`);
      }

      overlay.querySelector('.message').innerHTML = `
        <div style="text-align: center">
          <p>Capturing latest dashboard data...</p>
          <p>This will take about 2-3 minutes.</p>
          <p>The page will refresh automatically when complete.</p>
        </div>
      `;

      // Poll GitHub Actions for completion
      let attempts = 0;
      const checkStatus = async () => {
        if (attempts++ > 36) { // 3 minutes max
          throw new Error('Update timed out');
        }

        const checkResponse = await fetch(`https://api.github.com/repos/Abhinav-PIC/NPI-Dashboards/actions/runs?event=repository_dispatch&status=completed&per_page=1`);
        const runs = await checkResponse.json();
        
        if (runs.workflow_runs && runs.workflow_runs.length > 0) {
          const latestRun = runs.workflow_runs[0];
          if (latestRun.conclusion === 'success') {
            overlay.querySelector('.message').textContent = 'Update complete! Refreshing page...';
            setTimeout(() => window.location.reload(), 2000);
          } else if (latestRun.conclusion === 'failure') {
            throw new Error('Workflow failed');
          } else {
            setTimeout(checkStatus, 5000); // check again in 5 seconds
          }
        } else {
          setTimeout(checkStatus, 5000); // check again in 5 seconds
        }
      };

      setTimeout(checkStatus, 5000);

    } catch (error) {
      console.error('Error:', error);
      overlay.querySelector('.message').innerHTML = `
        <div style="text-align: center">
          <p>Could not update automatically.</p>
          <p>Please try again later or contact support.</p>
          <p style="margin-top: 20px; color: #666">(Click anywhere to close)</p>
        </div>
      `;
      
      overlay.onclick = () => {
        overlay.classList.remove('active');
      };
    }
  }
</script>

</body>
</html>
